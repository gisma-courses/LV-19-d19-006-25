<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="de" xml:lang="de"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Reudenbach, Philipps University Marburg (PUM)">

<title>Ecowitt Air Temperature — End-to-End applied Workflow – Advanced GIS &amp; RS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../reader/mc_2025_tec.html" rel="next">
<link href="../reader/mc_2025_1.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-2e6b1159dd83cca6b45a185263b00ab0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "Keine Treffer",
    "search-matching-documents-text": "Treffer",
    "search-copy-link-title": "Link in die Suche kopieren",
    "search-hide-matches-text": "Zusätzliche Treffer verbergen",
    "search-more-match-text": "weitere Treffer in diesem Dokument",
    "search-more-matches-text": "weitere Treffer in diesem Dokument",
    "search-clear-button-title": "Zurücksetzen",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Abbrechen",
    "search-submit-button-title": "Abschicken",
    "search-label": "Suchen"
  }
}</script>
<link href="../site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../site_libs/datatables-binding-0.33/datatables.js"></script>
<script src="../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="../site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="../site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../css/styles.css">
<meta property="og:title" content="Ecowitt Air Temperature — End-to-End applied Workflow – Advanced GIS &amp; RS">
<meta property="og:description" content="EON Summer School 2025">
<meta property="og:image" content="https://gisma-courses.github.io/LV-19-d19-006-25/images/mc4.png">
<meta property="og:site_name" content="Advanced GIS &amp; RS">
<meta property="og:image:height" content="433">
<meta property="og:image:width" content="1037">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Advanced GIS &amp; RS</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Suchen"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Navigation umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../base/faq.html"> <i class="bi bi-question-square-fill" role="img">
</i> 
<span class="menu-text">FAQ</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://ilias.uni-marburg.de/ilias.php?baseClass=ilrepositorygui&amp;ref_id=4407827"> <i class="bi bi-chat-left-text-fill" role="img">
</i> 
<span class="menu-text">ILIAS</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <a class="flex-grow-1 no-decor" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Seitenleiste umschalten" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
          <h1 class="quarto-secondary-nav-title">Ecowitt Air Temperature — End-to-End applied Workflow</h1>
        </a>     
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">GIS Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://gisma--courses-github-io.translate.goog/geoinfo-basis-qgis//unit01/unit01-01_reader_geo_raum.html?_x_tr_sl=de&amp;_x_tr_tl=en&amp;_x_tr_hl=de&amp;_x_tr_pto=wapp" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Space needs a scope</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://gisma--courses-github-io.translate.goog/geoinfo-basis-qgis//unit02/unit02-01_reader_gi_raum.html?_x_tr_sl=de&amp;_x_tr_tl=en&amp;_x_tr_hl=de&amp;_x_tr_pto=wapp" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Representation in GI</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">R-Spatial Basics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://gisma-courses.github.io/LV-19-d19-006/morea/geocomputation-with-r/reading-screencast-spatial-r-gis-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Some Pros &amp; Cons for R-Spatial</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://thinking-spatial.org/courses/geoinformationen_kommunizieren/kurs1/" class="sidebar-item-text sidebar-link">
 <span class="menu-text">First steps in geospatial R (German Ressource)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="https://r.geocompx.org/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Geocomputation with R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Lectures</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/cd-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial data classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/mc_2025_0.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Interpolation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/mc_2025_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PipeModel Idealized valley microclimate sandbox</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/mc_2025_microclimate_viewer_merged.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Ecowitt Air Temperature — End-to-End applied Workflow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/mc_2025_tec.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Microclimate Sensors &amp; Power-Supply Units</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/mc_2025_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Filling the Gaps</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reader/cd2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data retrieval</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Pattern Description</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Landscape Patterns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Landscape Patterns Reloaded</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pattern-based spatial analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../slides/slides_session5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Continous data spatial analysis</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Worksheets</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Abschnitt umschalten">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/comingsoon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coming&nbsp;Soon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/comingsoon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coming&nbsp;Soon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/comingsoon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coming&nbsp;Soon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/comingsoon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coming&nbsp;Soon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/comingsoon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coming&nbsp;Soon</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../worksheets/comingsoon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Coming&nbsp;Soon</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Auf dieser Seite</h2>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a>
  <ul class="collapse">
  <li><a href="#requirements-helpers" id="toc-requirements-helpers" class="nav-link" data-scroll-target="#requirements-helpers">0) Requirements &amp; Helpers</a></li>
  <li><a href="#project-paths" id="toc-project-paths" class="nav-link" data-scroll-target="#project-paths">1) Project &amp; Paths</a></li>
  <li><a href="#base-data-dem-strategy" id="toc-base-data-dem-strategy" class="nav-link" data-scroll-target="#base-data-dem-strategy">2) Base Data &amp; DEM Strategy</a></li>
  <li><a href="#ecowitt-ingestion-cleaning-aggregation" id="toc-ecowitt-ingestion-cleaning-aggregation" class="nav-link" data-scroll-target="#ecowitt-ingestion-cleaning-aggregation">3) Ecowitt Ingestion, Cleaning, Aggregation</a></li>
  <li><a href="#interpolation-preview-per-timestep-ked" id="toc-interpolation-preview-per-timestep-ked" class="nav-link" data-scroll-target="#interpolation-preview-per-timestep-ked">4) Interpolation Preview (Per-Timestep KED)</a></li>
  <li><a href="#method-comparison-for-densest-timestamp-working-code" id="toc-method-comparison-for-densest-timestamp-working-code" class="nav-link" data-scroll-target="#method-comparison-for-densest-timestamp-working-code">5) Method Comparison for Densest Timestamp (Working Code)</a></li>
  <li><a href="#optional-compute-all-time-steps" id="toc-optional-compute-all-time-steps" class="nav-link" data-scroll-target="#optional-compute-all-time-steps">6) (Optional) Compute All Time Steps</a></li>
  <li><a href="#save-csvs-for-the-one-timestamp" id="toc-save-csvs-for-the-one-timestamp" class="nav-link" data-scroll-target="#save-csvs-for-the-one-timestamp">7) Save CSVs for the One Timestamp</a></li>
  <li><a href="#console-summary" id="toc-console-summary" class="nav-link" data-scroll-target="#console-summary">8) Console Summary</a></li>
  <li><a href="#shiny-viewer-optional-uses-existing-files" id="toc-shiny-viewer-optional-uses-existing-files" class="nav-link" data-scroll-target="#shiny-viewer-optional-uses-existing-files">9) Shiny Viewer (Optional, uses existing files)</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<div class="quarto-about-marquee">
  <div class="about-image-container">
    <img src="../images/mc4.png" class="about-image " style="width: 50em;">
  </div>
  <div class="about-contents">
    <header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">Ecowitt Air Temperature — End-to-End applied Workflow</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Gesamten Code zeigen</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Gesamten Code verbergen</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">Quellcode anzeigen</a></li></ul></div></div>
<p class="subtitle lead">EON Summer School 2025</p>
</div>
<div class="quarto-title-meta">
    <div>
    <div class="quarto-title-meta-heading">Autor:in</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Reudenbach, Philipps University Marburg (PUM) </p>
          </div>
  </div>
    <div>
    <div class="quarto-title-meta-heading">Veröffentlichungsdatum</div>
    <div class="quarto-title-meta-contents">
      <p class="date">30. August 2025</p>
    </div>
  </div>
  </div>
</header> <main class="content" id="quarto-document-content">

<section id="overview" class="level1">
<h1>Overview</h1>
<p>This document demonstrates and explains a six-stage spatial pipeline for Ecowitt temperature data:</p>
<ul>
<li>Ingest &amp; clean: load two loggers, harmonize names, and aggregate to 3-hourly.</li>
<li>Interpolation preview: per-timestep KED (universal kriging) and a multi-panel plot.</li>
<li>Scale inference (L): fit a global variogram to get L50 / L95 (spatial correlation ranges).</li>
<li>Scale-matched predictors: build DEM-derived rasters (optionally slope/aspect/TRI) at the right scale.</li>
<li>Tune <span class="math inline">\(R^*\)</span>: select an optimal drift radius <span class="math inline">\(R\)</span> with block-CV (U-curve), then benchmark methods.</li>
<li>Diagnostics: export products, report scales, and compute an optional error budget.</li>
</ul>
<p><strong>Key concept:</strong> We use two DEMs on purpose — <code>DEM_scale</code> at native/coarser resolution drives scales, tuning, folds, CV, and error budget. <code>DEM_render</code> is an upsampled/aggregated DEM for pretty maps and interpolation output. This separation prevents the tuner from collapsing to 10 m just because pixels are tiny.</p>
<section id="requirements-helpers" class="level2">
<h2 data-anchor-id="requirements-helpers">0) Requirements &amp; Helpers</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Global setup + packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">width =</span> <span class="dv">100</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sf"</span>,<span class="st">"terra"</span>,<span class="st">"raster"</span>,<span class="st">"dplyr"</span>,<span class="st">"automap"</span>,<span class="st">"gstat"</span>,<span class="st">"mapview"</span>,<span class="st">"stars"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readxl"</span>,<span class="st">"stringr"</span>,<span class="st">"tidyr"</span>,<span class="st">"purrr"</span>,<span class="st">"lubridate"</span>,<span class="st">"rprojroot"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exactextractr"</span>,<span class="st">"zoo"</span>,<span class="st">"ggplot2"</span>,<span class="st">"viridis"</span>,<span class="st">"mgcv"</span>,<span class="st">"randomForest"</span>,<span class="st">"fields"</span>,<span class="st">"sp"</span>,<span class="st">"deldir"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"leaflet"</span>,<span class="st">"DT"</span>,<span class="st">"htmltools"</span>,<span class="st">"jsonlite"</span>,<span class="st">"shiny"</span> <span class="co"># viewer deps</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>need <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(pkgs, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(need)) <span class="fu">install.packages</span>(need, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, <span class="cf">function</span>(p) <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(p, <span class="at">character.only =</span> <span class="cn">TRUE</span>))))</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Small utilities (kept identical to your working script where applicable)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SpatRaster sicher "pinnen" (Datei-basiert) und als gültiges Objekt zurückgeben</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>.pin_rast <span class="ot">&lt;-</span> <span class="cf">function</span>(r, <span class="at">crs =</span> <span class="cn">NULL</span>, <span class="at">dir =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="st">"pinned"</span>) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">inherits</span>(r, <span class="st">"SpatRaster"</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(dir)) dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"run_cache"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir)) <span class="fu">dir.create</span>(dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir, <span class="fu">paste0</span>(name, <span class="st">".tif"</span>))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># immer schreiben → garantiert datei-gestützt und voll materialisiert</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">writeRaster</span>(r, f, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  rp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(f)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(crs)) {</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># nur projezieren, wenn noch nicht identisch</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    same <span class="ot">&lt;-</span> <span class="fu">try</span>(terra<span class="sc">::</span><span class="fu">crs</span>(rp, <span class="at">proj=</span><span class="cn">TRUE</span>) <span class="sc">==</span> <span class="fu">as.character</span>(crs), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">isTRUE</span>(same)) rp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(rp, <span class="fu">as.character</span>(crs), <span class="at">method =</span> <span class="st">"near"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sanity check</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(rp))</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  rp</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Prüfer: „lebt“ der Pointer?</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>.is_alive_spatr <span class="ot">&lt;-</span> <span class="cf">function</span>(r) {</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inherits</span>(r, <span class="st">"SpatRaster"</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(<span class="fu">try</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(r), <span class="at">silent =</span> <span class="cn">TRUE</span>), <span class="st">"try-error"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Safe, URL-friendly file slug</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>slug <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^0-9A-Za-z_-]+"</span>,<span class="st">"-"</span>, x)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"-+"</span>,<span class="st">"-"</span>, x)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gsub</span>(<span class="st">"(^-|-$)"</span>,<span class="st">""</span>, x)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Human-readable time labels from AYYYY... keys</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>pretty_time <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vapply</span>(x, <span class="cf">function</span>(s) {</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d{14}$"</span>, s)) {</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>      ts <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="fu">substr</span>(s, <span class="dv">2</span>, <span class="dv">15</span>), <span class="at">format =</span> <span class="st">"%Y%m%d%H%M%S"</span>, <span class="at">tz =</span> <span class="st">"UTC"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">format</span>(ts, <span class="st">"%Y-%m-%d %H:%M"</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d{8}(_D)?$"</span>, s)) {</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>      ts <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">substr</span>(s, <span class="dv">2</span>, <span class="dv">9</span>), <span class="at">format =</span> <span class="st">"%Y%m%d"</span>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">format</span>(ts, <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> s</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  }, <span class="fu">character</span>(<span class="dv">1</span>))</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick the most data-dense time-slice (max number of finite observations)</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>pick_densest_index <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_wide, var_names) {</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">sapply</span>(var_names, <span class="cf">function</span>(v) <span class="fu">sum</span>(<span class="fu">is.finite</span>(sf_wide[[v]])))</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which.max</span>(nn)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Build figure descriptions (viewer)</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>build_explanations <span class="ot">&lt;-</span> <span class="cf">function</span>(fig_dir, pick_ts) {</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  ts_label <span class="ot">&lt;-</span> <span class="fu">slug</span>(<span class="fu">pretty_time</span>(pick_ts))</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"timeseries_panel_grid.png"</span>,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">"timeseries_panel_grid.pdf"</span>,</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"u_curve_%s.png"</span>, ts_label),</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"u_curve_extras_%s.png"</span>, ts_label),</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"benchmark_%s.png"</span>, ts_label),</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"benchmark_extras_%s.png"</span>, ts_label)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  paths <span class="ot">&lt;-</span> <span class="fu">file.path</span>(fig_dir, files)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>  desc  <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Per-timestep KED previews; dots=stations; red=plot boundary."</span>,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Same as PNG, vector PDF."</span>,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"U-curve for tuning R via block-CV (drift-only)."</span>,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"U-curve with extra predictors."</span>,</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Method comparison at R* (lower RMSE is better)."</span>,</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Benchmark with extras at R*."</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>  keep <span class="ot">&lt;-</span> <span class="fu">file.exists</span>(paths)</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.list</span>(desc[keep]); <span class="fu">names</span>(out) <span class="ot">&lt;-</span> <span class="fu">basename</span>(paths[keep])</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<blockquote class="blockquote">
<p><strong>Why this matters:</strong> using fine pixels for scale estimation will cap <span class="math inline">\(R\)</span> at a few pixels, resulting in the “10 m fallback”. Keep <code>DEM_scale</code> at a realistic native/coarser resolution for L/R.</p>
</blockquote>
</section>
<section id="project-paths" class="level2">
<h2 data-anchor-id="project-paths">1) Project &amp; Paths</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust project root finder and paths</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(wd, <span class="st">"reader/all_functions_1.R"</span>))   <span class="co"># consolidated toolkit</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#fn_DTM        &lt;- file.path(wd, "reader/data_2024/copernicus_DEM.tif")</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>fn_DTM        <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/DEM.tif"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>fn_stations   <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/stations_prelim_modifiziert.gpkg"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>fn_area       <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/plot.shp"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>fn_temp_FC29  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/all_GW1000A-WIFIFC29.xlsx"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>fn_temp_DB2F  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/all_GW1000A-WIFIDB2F.xlsx"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>cleandata_rds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/climdata.RDS"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>out_dir    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/interpolated"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>fig_dir    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"fig"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>method_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"methods_compare"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>report_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"report"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (d <span class="cf">in</span> <span class="fu">c</span>(out_dir, fig_dir, method_dir, report_dir)) <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(d)) <span class="fu">dir.create</span>(d, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># CRS</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>epsg <span class="ot">&lt;-</span> <span class="st">"EPSG:32633"</span>  <span class="co"># UTM zone 33N</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>sf_crs_utm33 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(epsg)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="base-data-dem-strategy" class="level2">
<h2 data-anchor-id="base-data-dem-strategy">2) Base Data &amp; DEM Strategy</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DEMs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>DEM_scale  <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fn_DTM) <span class="sc">|&gt;</span> terra<span class="sc">::</span><span class="fu">project</span>(epsg)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>DEM_scale  <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(DEM_scale, <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">20</span>))  <span class="co"># coarsen ~20–25 m (as in your working code)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(DEM_scale) <span class="ot">&lt;-</span> <span class="st">"altitude"</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>DEM_render <span class="ot">&lt;-</span> DEM_scale <span class="sc">|&gt;</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>))  <span class="co"># for rendering products</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DEM_scale res (m): "</span>, <span class="fu">paste</span>(terra<span class="sc">::</span><span class="fu">res</span>(DEM_scale),  <span class="at">collapse=</span><span class="st">" x "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>DEM_scale res (m):  2.00223686801611 x 2.0022368680127 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DEM_render res (m):"</span>, <span class="fu">paste</span>(terra<span class="sc">::</span><span class="fu">res</span>(DEM_render), <span class="at">collapse=</span><span class="st">" x "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>DEM_render res (m): 20.0223686801606 x 20.022368680127 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stations and plot boundary → same CRS</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>stations_pos <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(fn_stations, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf_crs_utm33)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plot_area    <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(fn_area, <span class="at">quiet =</span> <span class="cn">TRUE</span>)     <span class="sc">|&gt;</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf_crs_utm33) <span class="sc">|&gt;</span> sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Altitude from DEM_scale (not the upsampled one)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>stations_pos <span class="ot">&lt;-</span> stations_pos <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">altitude =</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(DEM_scale, sf<span class="sc">::</span><span class="fu">st_buffer</span>(stations_pos, <span class="dv">1</span>), <span class="st">"mean"</span>))</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
  |                                                                                                
  |                                                                                          |   0%
  |                                                                                                
  |======                                                                                    |   7%
  |                                                                                                
  |=============                                                                             |  14%
  |                                                                                                
  |===================                                                                       |  21%
  |                                                                                                
  |==========================                                                                |  29%
  |                                                                                                
  |================================                                                          |  36%
  |                                                                                                
  |=======================================                                                   |  43%
  |                                                                                                
  |=============================================                                             |  50%
  |                                                                                                
  |===================================================                                       |  57%
  |                                                                                                
  |==========================================================                                |  64%
  |                                                                                                
  |================================================================                          |  71%
  |                                                                                                
  |=======================================================================                   |  79%
  |                                                                                                
  |=============================================================================             |  86%
  |                                                                                                
  |====================================================================================      |  93%
  |                                                                                                
  |==========================================================================================| 100%</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-30e4409849e39179307f" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-30e4409849e39179307f">{"x":{"filter":"none","vertical":false,"caption":"<caption style=\"caption-side: top; text-align: left;\">DEM summary (resolution, dimensions, CRS)<\/caption>","data":[["DEM_scale","DEM_render"],[2.00223686801611,20.02236868016062],[2.002236868012696,20.02236868012697],[222,23],[200,20],["PROJCRS[\"WGS 84 / UTM zone 33N\",\n    BASEGEOGCRS[\"WGS 84\",\n        ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n            MEMBER[\"World Geodetic System 1984 (Transit)\"],\n            MEMBER[\"World Geodetic System 1984 (G730)\"],\n            MEMBER[\"World Geodetic System 1984 (G873)\"],\n            MEMBER[\"World Geodetic System 1984 (G1150)\"],\n            MEMBER[\"World Geodetic System 1984 (G1674)\"],\n            MEMBER[\"World Geodetic System 1984 (G1762)\"],\n            MEMBER[\"World Geodetic System 1984 (G2139)\"],\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]],\n            ENSEMBLEACCURACY[2.0]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4326]],\n    CONVERSION[\"UTM zone 33N\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",15,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",0.9996,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",500000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Navigation and medium accuracy spatial referencing.\"],\n        AREA[\"Between 12°E and 18°E, northern hemisphere between equator and 84°N, onshore and offshore. Austria. Bosnia and Herzegovina. Cameroon. Central African Republic. Chad. Congo. Croatia. Czechia. Democratic Republic of the Congo (Zaire). Gabon. Germany. Hungary. Italy. Libya. Malta. Niger. Nigeria. Norway. Poland. San Marino. Slovakia. Slovenia. Svalbard. Sweden. Vatican City State.\"],\n        BBOX[0,12,84,18]],\n    ID[\"EPSG\",32633]]","PROJCRS[\"WGS 84 / UTM zone 33N\",\n    BASEGEOGCRS[\"WGS 84\",\n        ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n            MEMBER[\"World Geodetic System 1984 (Transit)\"],\n            MEMBER[\"World Geodetic System 1984 (G730)\"],\n            MEMBER[\"World Geodetic System 1984 (G873)\"],\n            MEMBER[\"World Geodetic System 1984 (G1150)\"],\n            MEMBER[\"World Geodetic System 1984 (G1674)\"],\n            MEMBER[\"World Geodetic System 1984 (G1762)\"],\n            MEMBER[\"World Geodetic System 1984 (G2139)\"],\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]],\n            ENSEMBLEACCURACY[2.0]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4326]],\n    CONVERSION[\"UTM zone 33N\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",15,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",0.9996,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",500000,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Navigation and medium accuracy spatial referencing.\"],\n        AREA[\"Between 12°E and 18°E, northern hemisphere between equator and 84°N, onshore and offshore. Austria. Bosnia and Herzegovina. Cameroon. Central African Republic. Chad. Congo. Croatia. Czechia. Democratic Republic of the Congo (Zaire). Gabon. Germany. Hungary. Italy. Libya. Malta. Niger. Nigeria. Norway. Poland. San Marino. Slovakia. Slovenia. Svalbard. Sweden. Vatican City State.\"],\n        BBOX[0,12,84,18]],\n    ID[\"EPSG\",32633]]"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>DEM<\/th>\n      <th>res_x<\/th>\n      <th>res_y<\/th>\n      <th>ncol<\/th>\n      <th>nrow<\/th>\n      <th>crs<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"dom":"tip","columnDefs":[{"className":"dt-right","targets":[1,2,3,4]},{"name":"DEM","targets":0},{"name":"res_x","targets":1},{"name":"res_y","targets":2},{"name":"ncol","targets":3},{"name":"nrow","targets":4},{"name":"crs","targets":5}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="ecowitt-ingestion-cleaning-aggregation" class="level2">
<h2 data-anchor-id="ecowitt-ingestion-cleaning-aggregation">3) Ecowitt Ingestion, Cleaning, Aggregation</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>temp_FC29 <span class="ot">&lt;-</span> <span class="fu">extract_ecowitt_core_vars</span>(fn_temp_FC29)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
New names:
• `` -&gt; `...1`
• `` -&gt; `...2`
• `` -&gt; `...3`
• `` -&gt; `...4`
• `` -&gt; `...5`
• `` -&gt; `...6`
• `` -&gt; `...7`
• `` -&gt; `...8`
• `` -&gt; `...9`
• `` -&gt; `...10`
• `` -&gt; `...11`
• `` -&gt; `...12`
• `` -&gt; `...13`
• `` -&gt; `...14`
• `` -&gt; `...15`
• `` -&gt; `...16`
• `` -&gt; `...17`
• `` -&gt; `...18`
• `` -&gt; `...19`
• `` -&gt; `...20`
• `` -&gt; `...21`
• `` -&gt; `...22`
• `` -&gt; `...23`
• `` -&gt; `...24`
• `` -&gt; `...25`
• `` -&gt; `...26`
• `` -&gt; `...27`
• `` -&gt; `...28`
• `` -&gt; `...29`
• `` -&gt; `...30`
• `` -&gt; `...31`
• `` -&gt; `...32`
• `` -&gt; `...33`
• `` -&gt; `...34`
• `` -&gt; `...35`
• `` -&gt; `...36`
• `` -&gt; `...37`
• `` -&gt; `...38`
• `` -&gt; `...39`
• `` -&gt; `...40`
• `` -&gt; `...41`
• `` -&gt; `...42`
• `` -&gt; `...43`
• `` -&gt; `...44`
• `` -&gt; `...45`
• `` -&gt; `...46`
• `` -&gt; `...47`
• `` -&gt; `...48`
• `` -&gt; `...49`
• `` -&gt; `...50`
• `` -&gt; `...51`
• `` -&gt; `...52`
• `` -&gt; `...53`
• `` -&gt; `...54`
• `` -&gt; `...55`
• `` -&gt; `...56`
• `` -&gt; `...57`
• `` -&gt; `...58`
• `` -&gt; `...59`
• `` -&gt; `...60`
• `` -&gt; `...61`
• `` -&gt; `...62`
• `` -&gt; `...63`
• `` -&gt; `...64`
• `` -&gt; `...65`
• `` -&gt; `...66`
• `` -&gt; `...67`
• `` -&gt; `...68`
• `` -&gt; `...69`
• `` -&gt; `...70`
• `` -&gt; `...71`
• `` -&gt; `...72`
• `` -&gt; `...73`
• `` -&gt; `...74`
• `` -&gt; `...75`
• `` -&gt; `...76`
• `` -&gt; `...77`
• `` -&gt; `...78`
• `` -&gt; `...79`
• `` -&gt; `...80`</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>temp_DB2F <span class="ot">&lt;-</span> <span class="fu">extract_ecowitt_core_vars</span>(fn_temp_DB2F)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
New names:
• `` -&gt; `...1`
• `` -&gt; `...2`
• `` -&gt; `...3`
• `` -&gt; `...4`
• `` -&gt; `...5`
• `` -&gt; `...6`
• `` -&gt; `...7`
• `` -&gt; `...8`
• `` -&gt; `...9`
• `` -&gt; `...10`
• `` -&gt; `...11`
• `` -&gt; `...12`
• `` -&gt; `...13`
• `` -&gt; `...14`
• `` -&gt; `...15`
• `` -&gt; `...16`
• `` -&gt; `...17`
• `` -&gt; `...18`
• `` -&gt; `...19`
• `` -&gt; `...20`
• `` -&gt; `...21`
• `` -&gt; `...22`
• `` -&gt; `...23`
• `` -&gt; `...24`
• `` -&gt; `...25`
• `` -&gt; `...26`
• `` -&gt; `...27`
• `` -&gt; `...28`
• `` -&gt; `...29`
• `` -&gt; `...30`
• `` -&gt; `...31`
• `` -&gt; `...32`
• `` -&gt; `...33`
• `` -&gt; `...34`
• `` -&gt; `...35`
• `` -&gt; `...36`
• `` -&gt; `...37`
• `` -&gt; `...38`
• `` -&gt; `...39`
• `` -&gt; `...40`
• `` -&gt; `...41`
• `` -&gt; `...42`
• `` -&gt; `...43`
• `` -&gt; `...44`
• `` -&gt; `...45`
• `` -&gt; `...46`
• `` -&gt; `...47`
• `` -&gt; `...48`
• `` -&gt; `...49`
• `` -&gt; `...50`
• `` -&gt; `...51`
• `` -&gt; `...52`
• `` -&gt; `...53`
• `` -&gt; `...54`
• `` -&gt; `...55`
• `` -&gt; `...56`
• `` -&gt; `...57`</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>t_rh_all  <span class="ot">&lt;-</span> <span class="fu">merge_ecowitt_logger_vars</span>(temp_FC29, temp_DB2F)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean display names and map to verbose station names</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (meas <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"temperature"</span>,<span class="st">"humidity"</span>)) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  t_rh_all[[meas]] <span class="ot">&lt;-</span> t_rh_all[[meas]] <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">to_verbose</span>(.x, <span class="fu">ifelse</span>(meas<span class="sc">==</span><span class="st">"temperature"</span>,<span class="st">"Temperature"</span>,<span class="st">"Humidity"</span>)), <span class="sc">-</span>Time) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>()</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate to 3-hour steps</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>temp_agg <span class="ot">&lt;-</span> t_rh_all<span class="sc">$</span>temperature <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">time =</span> lubridate<span class="sc">::</span><span class="fu">floor_date</span>(Time, <span class="st">"3 hours"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(temp_agg) <span class="ot">&lt;-</span> <span class="fu">clean_ids</span>(<span class="fu">names</span>(temp_agg))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># long → wide matrix: station rows, time columns</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>temp_matrix <span class="ot">&lt;-</span> temp_agg <span class="sc">%&gt;%</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"stationid"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> time, <span class="at">values_from =</span> value)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Join to station geometry and altitude</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>stations_pos <span class="ot">&lt;-</span> stations_pos <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">stationid =</span> <span class="fu">to_verbose</span>(stationid))</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(stations_pos, temp_matrix, <span class="at">by =</span> <span class="st">"stationid"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Hygiene</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>stations_pos<span class="sc">$</span>stationid <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">(℃</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(％</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">%</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, stations_pos<span class="sc">$</span>stationid)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>stationid            <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">(℃</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(％</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">%</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, m<span class="sc">$</span>stationid)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(m)               <span class="ot">&lt;-</span> <span class="fu">fix_names</span>(<span class="fu">names</span>(m))</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(m, cleandata_rds)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="datatables html-widget html-fill-item" id="htmlwidget-2e17466358a46d139971" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-2e17466358a46d139971">{"x":{"filter":"none","vertical":false,"caption":"<caption style=\"caption-side: top; text-align: left;\">Plot boundary summary<\/caption>","data":[["area_crs","area_bbox"],["[1] \"EPSG:32633\"","[1] \"183000 / 5748000 / 183300 / 5749000\""]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>Key<\/th>\n      <th>Value<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":10,"dom":"tip","columnDefs":[{"name":"Key","targets":0},{"name":"Value","targets":1}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="interpolation-preview-per-timestep-ked" class="level2">
<h2 data-anchor-id="interpolation-preview-per-timestep-ked">4) Interpolation Preview (Per-Timestep KED)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>min_pts <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">grep</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d{8,14}"</span>, <span class="fu">names</span>(m), <span class="at">value =</span> <span class="cn">TRUE</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>kriged_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(vars, <span class="cf">function</span>(v) {</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">interpolate_kriging</span>(v, m, DEM_render, <span class="at">output_dir =</span> out_dir, <span class="at">label =</span> <span class="st">"pretty"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230827150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230827150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230827180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230827180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230828150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230828150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230828180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230828180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230828210000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230828210000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230829</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829030000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230829030000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829060000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230829060000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829090000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230829090000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829120000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230829120000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829150000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230829150000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829180000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230829180000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230829210000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230829210000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230830_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830030000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230830030000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830060000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230830060000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830090000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230830090000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830120000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230830120000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230830150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230830180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230830210000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230830210000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230831_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831030000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230831030000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831060000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230831060000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831090000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230831090000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831120000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230831120000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230831150000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230831180000</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230831210000</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✔ Written: /home/creu/edu/gisma-courses/LV-19-d19-006-25/reader/interpolated/A20230831210000_interpolated.tif</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Interpolating: A20230901</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in interpolate_kriging(v, m, DEM_render, output_dir = out_dir, label = "pretty"): Variogram
failed for A20230901</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(kriged_list) <span class="ot">&lt;-</span> vars</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Shared color scale across all timestamps</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>panel <span class="ot">&lt;-</span> <span class="fu">timeseries_panel</span>(</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">kriged_list        =</span> kriged_list,</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot_area          =</span> plot_area,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stations_pos       =</span> stations_pos,</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">cells_target       =</span> <span class="dv">150000</span>,</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_cols           =</span> <span class="dv">4</span>,</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_pretty_time  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_png            =</span> <span class="fu">file.path</span>(fig_dir, <span class="st">"timeseries_panel_grid.png"</span>),</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_pdf            =</span> <span class="fu">file.path</span>(fig_dir, <span class="st">"timeseries_panel_grid.pdf"</span>),</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_label         =</span> <span class="st">"Temperature"</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will replace the existing
one.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>panel<span class="sc">$</span>plot</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="mc_2025_microclimate_viewer_merged_files/figure-html/panel-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="method-comparison-for-densest-timestamp-working-code" class="level2">
<h2 data-anchor-id="method-comparison-for-densest-timestamp-working-code">5) Method Comparison for Densest Timestamp (Working Code)</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Densest timestamp</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>pick_idx <span class="ot">&lt;-</span> <span class="fu">pick_densest_index</span>(m, vars)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>pick_ts  <span class="ot">&lt;-</span> <span class="fu">names</span>(m)[pick_idx]</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extra predictors (kept as in your working code)</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>extra_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">slope  =</span> terra<span class="sc">::</span><span class="fu">terrain</span>(DEM_scale, <span class="at">v =</span> <span class="st">"slope"</span>,  <span class="at">unit =</span> <span class="st">"degrees"</span>),</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">aspect =</span> terra<span class="sc">::</span><span class="fu">terrain</span>(DEM_scale, <span class="at">v =</span> <span class="st">"aspect"</span>),</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">tri    =</span> terra<span class="sc">::</span><span class="fu">terrain</span>(DEM_scale, <span class="at">v =</span> <span class="st">"TRI"</span>)</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="co"># One timestamp (densest), with extras</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>res_one <span class="ot">&lt;-</span> <span class="fu">run_one</span>(</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">v           =</span> vars[[pick_idx]],</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">m           =</span> m,</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEM_render  =</span> DEM_render,</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEM_scale   =</span> DEM_scale,</span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">method_dir  =</span> method_dir,</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig_dir     =</span> fig_dir,</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">report_dir  =</span> report_dir,</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">extra_preds =</span> extra_list,</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_figs   =</span> <span class="cn">TRUE</span></span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(b$scale.est): NaNs produced
Warning in log(b$scale.est): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(b$scale.est): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully
Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully
Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(b$scale.est): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(b$scale.est): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(b$scale.est): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully
Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully
Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully
Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in log(b$scale.est): NaNs produced</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully
Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L, : Fitting
terminated with step failure - check results carefully</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[inverse distance weighted interpolation]
[using ordinary kriging]
[using universal kriging]
[inverse distance weighted interpolation]
[using ordinary kriging]
[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>R*: tuner failed; falling back to 56.8593 m.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in x@pntr$rastDistance(target, exclude, keepNA, tolower(unit), TRUE, : GDAL Message 1:
Pixels not square, distances will be inaccurate.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>R*: tuner failed; falling back to 56.8593 m.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in x@pntr$rastDistance(target, exclude, keepNA, tolower(unit), TRUE, : GDAL Message 1:
Pixels not square, distances will be inaccurate.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]
[using ordinary kriging]
[inverse distance weighted interpolation]
[using universal kriging]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]
[using ordinary kriging]</code></pre>
</div>
</div>
</section>
<section id="optional-compute-all-time-steps" class="level2">
<h2 data-anchor-id="optional-compute-all-time-steps">6) (Optional) Compute All Time Steps</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>compute_all <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">isTRUE</span>(compute_all)) {</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  req <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"m"</span>,<span class="st">"DEM_render"</span>,<span class="st">"DEM_scale"</span>,<span class="st">"method_dir"</span>,<span class="st">"fig_dir"</span>,<span class="st">"report_dir"</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  miss <span class="ot">&lt;-</span> req[<span class="sc">!</span><span class="fu">vapply</span>(req, exists, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="at">inherits =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(miss)) <span class="fu">stop</span>(<span class="st">"Fehlende Objekte im Environment: "</span>, <span class="fu">paste</span>(miss, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>  .best_from_bench <span class="ot">&lt;-</span> <span class="cf">function</span>(bench_obj) {</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(bench_obj) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(bench_obj<span class="sc">$</span>table) <span class="sc">||</span> <span class="fu">nrow</span>(bench_obj<span class="sc">$</span>table) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> bench_obj<span class="sc">$</span>table</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> b[<span class="fu">is.finite</span>(b<span class="sc">$</span>RMSE), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">nrow</span>(b)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> b[<span class="fu">order</span>(b<span class="sc">$</span>RMSE), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    b[<span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"method"</span>,<span class="st">"RMSE"</span>), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Starte compute_all für %d Zeitschritte …"</span>, <span class="fu">length</span>(vars)))</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>  res_all <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">lapply</span>(vars, <span class="cf">function</span>(vv) {</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"→ run_one: "</span>, <span class="fu">pretty_time</span>(vv))</span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run_one</span>(</span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">v           =</span> vv,</span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">m           =</span> m,</span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">DEM_render  =</span> DEM_render,</span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">DEM_scale   =</span> DEM_scale,</span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">method_dir  =</span> method_dir,</span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">fig_dir     =</span> fig_dir,</span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">report_dir  =</span> report_dir,</span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">extra_preds =</span> extra_list,</span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">save_figs   =</span> <span class="cn">TRUE</span>,</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">save_tables =</span> <span class="cn">TRUE</span></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"run_one fehlgeschlagen für "</span>, vv, <span class="st">": "</span>, <span class="fu">conditionMessage</span>(e))</span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>  }), vars)</span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(res_all, <span class="fu">file.path</span>(report_dir, <span class="st">"all_results.RDS"</span>))</span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>  summ <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(res_all), <span class="cf">function</span>(k) {</span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> res_all[[k]]</span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(r)) {</span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">ts_key      =</span> k, </span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">stamp       =</span> <span class="fu">pretty_time</span>(k),</span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">R_star      =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">best_source =</span> <span class="cn">NA_character_</span>,  <span class="co"># "no_extras"/"with_extras"</span></span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">best_method =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb115-53"><a href="#cb115-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">best_RMSE   =</span> <span class="cn">NA_real_</span></span>
<span id="cb115-54"><a href="#cb115-54" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb115-55"><a href="#cb115-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb115-56"><a href="#cb115-56" aria-hidden="true" tabindex="-1"></a>    rstar <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(r<span class="sc">$</span>tune<span class="sc">$</span>R_star))</span>
<span id="cb115-57"><a href="#cb115-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(rstar)) rstar <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb115-58"><a href="#cb115-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-59"><a href="#cb115-59" aria-hidden="true" tabindex="-1"></a>    b0 <span class="ot">&lt;-</span> <span class="fu">.best_from_bench</span>(r<span class="sc">$</span>bench)</span>
<span id="cb115-60"><a href="#cb115-60" aria-hidden="true" tabindex="-1"></a>    bE <span class="ot">&lt;-</span> <span class="fu">.best_from_bench</span>(r<span class="sc">$</span>bench_ex)</span>
<span id="cb115-61"><a href="#cb115-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-62"><a href="#cb115-62" aria-hidden="true" tabindex="-1"></a>    score0 <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(b0) <span class="sc">&amp;&amp;</span> <span class="fu">isTRUE</span>(<span class="fu">is.finite</span>(b0<span class="sc">$</span>RMSE))) b0<span class="sc">$</span>RMSE <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb115-63"><a href="#cb115-63" aria-hidden="true" tabindex="-1"></a>    scoreE <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(bE) <span class="sc">&amp;&amp;</span> <span class="fu">isTRUE</span>(<span class="fu">is.finite</span>(bE<span class="sc">$</span>RMSE))) bE<span class="sc">$</span>RMSE <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb115-64"><a href="#cb115-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-65"><a href="#cb115-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.infinite</span>(score0) <span class="sc">&amp;&amp;</span> <span class="fu">is.infinite</span>(scoreE)) {</span>
<span id="cb115-66"><a href="#cb115-66" aria-hidden="true" tabindex="-1"></a>      src <span class="ot">&lt;-</span> <span class="cn">NA_character_</span>; bm <span class="ot">&lt;-</span> <span class="cn">NA_character_</span>; br <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb115-67"><a href="#cb115-67" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (score0 <span class="sc">&lt;=</span> scoreE) {</span>
<span id="cb115-68"><a href="#cb115-68" aria-hidden="true" tabindex="-1"></a>      src <span class="ot">&lt;-</span> <span class="st">"no_extras"</span>; bm <span class="ot">&lt;-</span> b0<span class="sc">$</span>method; br <span class="ot">&lt;-</span> score0</span>
<span id="cb115-69"><a href="#cb115-69" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb115-70"><a href="#cb115-70" aria-hidden="true" tabindex="-1"></a>      src <span class="ot">&lt;-</span> <span class="st">"with_extras"</span>; bm <span class="ot">&lt;-</span> bE<span class="sc">$</span>method; br <span class="ot">&lt;-</span> scoreE</span>
<span id="cb115-71"><a href="#cb115-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb115-72"><a href="#cb115-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-73"><a href="#cb115-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb115-74"><a href="#cb115-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">ts_key      =</span> k,</span>
<span id="cb115-75"><a href="#cb115-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">stamp       =</span> <span class="fu">pretty_time</span>(k),</span>
<span id="cb115-76"><a href="#cb115-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">R_star      =</span> rstar,</span>
<span id="cb115-77"><a href="#cb115-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">best_source =</span> src,</span>
<span id="cb115-78"><a href="#cb115-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">best_method =</span> bm,</span>
<span id="cb115-79"><a href="#cb115-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">best_RMSE   =</span> br</span>
<span id="cb115-80"><a href="#cb115-80" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb115-81"><a href="#cb115-81" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb115-82"><a href="#cb115-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-83"><a href="#cb115-83" aria-hidden="true" tabindex="-1"></a>  utils<span class="sc">::</span><span class="fu">write.csv</span>(summ, <span class="fu">file.path</span>(report_dir, <span class="st">"summary_Rstar_bestmethod.csv"</span>), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb115-84"><a href="#cb115-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"✔ Fertig: summary_Rstar_bestmethod.csv geschrieben."</span>)</span>
<span id="cb115-85"><a href="#cb115-85" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="save-csvs-for-the-one-timestamp" class="level2">
<h2 data-anchor-id="save-csvs-for-the-one-timestamp">7) Save CSVs for the One Timestamp</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>ts_label <span class="ot">&lt;-</span> <span class="fu">pretty_time</span>(pick_ts)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>bench_base_csv <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"benchmark_%s.csv"</span>,        <span class="fu">slug</span>(ts_label)))</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>bench_ex_csv   <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"benchmark_extras_%s.csv"</span>, <span class="fu">slug</span>(ts_label)))</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>eb_base_csv    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"error_budget_%s.csv"</span>,     <span class="fu">slug</span>(ts_label)))</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>eb_ex_csv      <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"error_budget_extras_%s.csv"</span>, <span class="fu">slug</span>(ts_label)))</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.list</span>(res_one<span class="sc">$</span>bench)    <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>bench<span class="sc">$</span>table))    <span class="fu">write.csv</span>(res_one<span class="sc">$</span>bench<span class="sc">$</span>table,    bench_base_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.list</span>(res_one<span class="sc">$</span>bench_ex) <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>bench_ex<span class="sc">$</span>table)) <span class="fu">write.csv</span>(res_one<span class="sc">$</span>bench_ex<span class="sc">$</span>table, bench_ex_csv,   <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>errtab))    <span class="fu">write.csv</span>(res_one<span class="sc">$</span>errtab,    eb_base_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>errtab_ex)) <span class="fu">write.csv</span>(res_one<span class="sc">$</span>errtab_ex, eb_ex_csv,   <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="console-summary" class="level2">
<h2 data-anchor-id="console-summary">8) Console Summary</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>n_stations <span class="ot">&lt;-</span> <span class="fu">nrow</span>(stations_pos)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>n_pts_ts   <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.finite</span>(m[[pick_ts]]))</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>Ls         <span class="ot">&lt;-</span> <span class="fu">get_Ls</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>L)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>Ls_e       <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(res_one<span class="sc">$</span>wf_ex)) <span class="fu">get_Ls</span>(res_one<span class="sc">$</span>wf_ex<span class="sc">$</span>L) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>Rstar_base <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(res_one<span class="sc">$</span>tune<span class="sc">$</span>R_star))</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>Rstar_ex   <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(res_one<span class="sc">$</span>tune_ex<span class="sc">$</span>R_star))</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Chosen R (micro/local): %s / %s m</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(<span class="fu">is.finite</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'micro'</span>]), <span class="fu">round</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'micro'</span>]), <span class="st">"NA"</span>),</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(<span class="fu">is.finite</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'local'</span>]), <span class="fu">round</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'local'</span>]), <span class="st">"NA"</span>)</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Chosen R (micro/local): 19 / 57 m</code></pre>
</div>
</div>
</section>
<section id="shiny-viewer-optional-uses-existing-files" class="level2">
<h2 data-anchor-id="shiny-viewer-optional-uses-existing-files">9) Shiny Viewer (Optional, uses existing files)</h2>
<blockquote class="blockquote">
<p>The viewer launches a Shiny app; to not block Quarto rendering, the launch is wrapped in <code>if (interactive())</code>.</p>
</blockquote>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal viewer injection: use your working run_mc_viewer() with robust file matching</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>raster_path <span class="ot">&lt;-</span> <span class="cf">function</span>(method, ts) {</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(method) <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">length</span>(ts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">tolower</span>(method)</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>  .ts_tokens <span class="ot">&lt;-</span> <span class="cf">function</span>(ts_key) {</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    raw <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">as.character</span>(ts_key))</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    pty <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">pretty_time</span>(ts_key))</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    slug_pt <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^0-9A-Za-z_-]+"</span>,<span class="st">"-"</span>, pty)</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    d14 <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^a"</span>, <span class="st">""</span>, raw)</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    ymd  <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">nchar</span>(d14) <span class="sc">&gt;=</span> <span class="dv">8</span>) <span class="fu">substr</span>(d14,<span class="dv">1</span>,<span class="dv">8</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    hhmm <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">nchar</span>(d14) <span class="sc">&gt;=</span> <span class="dv">12</span>) <span class="fu">substr</span>(d14,<span class="dv">9</span>,<span class="dv">12</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>    comp1 <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ymd) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(hhmm))</span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="fu">substr</span>(ymd,<span class="dv">1</span>,<span class="dv">4</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">5</span>,<span class="dv">6</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">7</span>,<span class="dv">8</span>),<span class="st">"-"</span>,</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>             <span class="fu">substr</span>(hhmm,<span class="dv">1</span>,<span class="dv">2</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(hhmm,<span class="dv">3</span>,<span class="dv">4</span>)) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>    comp2 <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">""</span>, comp1)</span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>    ymd_dash <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ymd)) <span class="fu">paste0</span>(<span class="fu">substr</span>(ymd,<span class="dv">1</span>,<span class="dv">4</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">5</span>,<span class="dv">6</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">7</span>,<span class="dv">8</span>)) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(<span class="fu">na.omit</span>(<span class="fu">c</span>(raw, slug_pt, comp1, comp2, ymd_dash, ymd)))</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a>  toks <span class="ot">&lt;-</span> <span class="fu">.ts_tokens</span>(ts)</span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>  tok_rx <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[-_]"</span>, <span class="st">"[-_]"</span>, toks)</span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>  all_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(method_dir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.tif$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(all_files)) <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">basename</span>(all_files))</span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>  keep_pref <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">"^"</span>, m, <span class="st">"_"</span>), b)</span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a>  files_m <span class="ot">&lt;-</span> all_files[keep_pref]; b_m <span class="ot">&lt;-</span> b[keep_pref]</span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files_m)) {</span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>    score <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="fu">seq_along</span>(b_m), <span class="cf">function</span>(i) {</span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">vapply</span>(tok_rx, <span class="cf">function</span>(rx) <span class="cf">if</span> (<span class="fu">grepl</span>(rx, b_m[i], <span class="at">perl =</span> <span class="cn">TRUE</span>)) <span class="fu">nchar</span>(rx) <span class="cf">else</span> <span class="dv">0</span>L, <span class="fu">integer</span>(<span class="dv">1</span>))))</span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a>    }, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(score <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>      best <span class="ot">&lt;-</span> files_m[score <span class="sc">==</span> <span class="fu">max</span>(score)]</span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a>      bbest <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">basename</span>(best))</span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>      idxR <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"_rstar</span><span class="sc">\\</span><span class="st">.tif$"</span>, bbest)</span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(idxR)) <span class="fu">return</span>(best[idxR[<span class="dv">1</span>]])</span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>      idxL <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"_l95</span><span class="sc">\\</span><span class="st">.tif$"</span>, bbest)</span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(idxL)) <span class="fu">return</span>(best[idxL[<span class="dv">1</span>]])</span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(best[<span class="dv">1</span>])</span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">toupper</span>(method) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"KED"</span>,<span class="st">"PREVIEW"</span>)) {</span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>    out_dir_local <span class="ot">&lt;-</span> <span class="fu">dirname</span>(method_dir)</span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>    prev <span class="ot">&lt;-</span> <span class="fu">list.files</span>(out_dir_local, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.tif$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(prev)) {</span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a>      bp <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">basename</span>(prev))</span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>      rx_prev <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"^("</span>, <span class="fu">paste0</span>(tok_rx, <span class="at">collapse =</span> <span class="st">"|"</span>), <span class="st">")_interpolated(_wgs84)?</span><span class="sc">\\</span><span class="st">.tif$"</span>)</span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>      hit <span class="ot">&lt;-</span> <span class="fu">grepl</span>(rx_prev, bp, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(hit)) <span class="fu">return</span>(prev[<span class="fu">which</span>(hit)[<span class="dv">1</span>]])</span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA_character_</span></span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Only launch interactively</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">interactive</span>()) {</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  explanations <span class="ot">&lt;-</span> <span class="fu">build_explanations</span>(<span class="at">fig_dir =</span> fig_dir, <span class="at">pick_ts =</span> vars[[pick_idx]])</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run_mc_viewer</span>(</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">vars         =</span> vars,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_dir   =</span> method_dir,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">fig_dir      =</span> fig_dir,</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">stations_pos =</span> stations_pos,</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot_area    =</span> plot_area,</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">wf           =</span> res_one<span class="sc">$</span>wf,</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">wf_ex        =</span> res_one<span class="sc">$</span>wf_ex,</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">tune         =</span> res_one<span class="sc">$</span>tune,</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">tune_ex      =</span> res_one<span class="sc">$</span>tune_ex,</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">bench        =</span> res_one<span class="sc">$</span>bench,</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">bench_ex     =</span> res_one<span class="sc">$</span>bench_ex,</span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">tab_err      =</span> res_one<span class="sc">$</span>errtab,</span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">tab_err_ex   =</span> res_one<span class="sc">$</span>errtab_ex,</span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">explanations =</span> explanations</span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->
</section>
</section>
</main> 
  </div>
</div>
 <!-- /main -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Jahr einsetzen
  document.querySelectorAll('.year').forEach(function (el) {
    el.textContent = new Date().getFullYear();
  });

  // Impressum-Link relativ zum Projekt-Root setzen
  const offset = document.querySelector('meta[name="quarto:offset"]')?.getAttribute('content') || '';
  document.querySelectorAll('a.impressum-link').forEach(function (a) {
    a.setAttribute('href', offset + 'base/impressum.html');
  });
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Kopiert");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Kopiert");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("^(?:http:|https:)//(gisma\-courses\.github\.io/LV\-19\-d19\-006\-25|www\.quarto\.org/custom)");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../reader/mc_2025_1.html" class="pagination-link" aria-label="PipeModel Idealized valley microclimate sandbox">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">PipeModel Idealized valley microclimate sandbox</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../reader/mc_2025_tec.html" class="pagination-link" aria-label="Microclimate Sensors &amp; Power-Supply Units">
        <span class="nav-page-text">Microclimate Sensors &amp; Power-Supply Units</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Quellcode</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb121" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Ecowitt Air Temperature — End-to-End applied Workflow"</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "EON Summer School 2025"</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Chris Reudenbach, Philipps University Marburg (PUM)</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-08-30"</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="co">#title-block-banner: ../images/mc4.png</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co">#title-block-banner-color: black</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> ../images/mc4.png</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="an">about:</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="co">  id: image-heading</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a><span class="co">  template: marquee</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a><span class="co">  image-width: 50em</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 2</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: false</span></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: true</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a><span class="co">  message: true</span></span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: false</span></span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a><span class="fu"># Overview</span></span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a>This document demonstrates and explains a six-stage spatial pipeline for Ecowitt temperature data:</span>
<span id="cb121-32"><a href="#cb121-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-33"><a href="#cb121-33" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Ingest &amp; clean: load two loggers, harmonize names, and aggregate to 3-hourly.</span>
<span id="cb121-34"><a href="#cb121-34" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Interpolation preview: per-timestep KED (universal kriging) and a multi-panel plot.</span>
<span id="cb121-35"><a href="#cb121-35" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Scale inference (L): fit a global variogram to get L50 / L95 (spatial correlation ranges).</span>
<span id="cb121-36"><a href="#cb121-36" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Scale-matched predictors: build DEM-derived rasters (optionally slope/aspect/TRI) at the right scale.</span>
<span id="cb121-37"><a href="#cb121-37" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Tune $R^*$: select an optimal drift radius $R$ with block-CV (U-curve), then benchmark methods.</span>
<span id="cb121-38"><a href="#cb121-38" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Diagnostics: export products, report scales, and compute an optional error budget.</span>
<span id="cb121-39"><a href="#cb121-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-40"><a href="#cb121-40" aria-hidden="true" tabindex="-1"></a>**Key concept:** We use two DEMs on purpose — <span class="in">`DEM_scale`</span> at native/coarser resolution drives scales, tuning, folds, CV, and error budget. <span class="in">`DEM_render`</span> is an upsampled/aggregated DEM for pretty maps and interpolation output. This separation prevents the tuner from collapsing to 10 m just because pixels are tiny.</span>
<span id="cb121-41"><a href="#cb121-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-42"><a href="#cb121-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## 0) Requirements &amp; Helpers</span></span>
<span id="cb121-43"><a href="#cb121-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-46"><a href="#cb121-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-47"><a href="#cb121-47" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb121-48"><a href="#cb121-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Global setup + packages</span></span>
<span id="cb121-49"><a href="#cb121-49" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb121-50"><a href="#cb121-50" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">width =</span> <span class="dv">100</span>)</span>
<span id="cb121-51"><a href="#cb121-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-52"><a href="#cb121-52" aria-hidden="true" tabindex="-1"></a>pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb121-53"><a href="#cb121-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sf"</span>,<span class="st">"terra"</span>,<span class="st">"raster"</span>,<span class="st">"dplyr"</span>,<span class="st">"automap"</span>,<span class="st">"gstat"</span>,<span class="st">"mapview"</span>,<span class="st">"stars"</span>,</span>
<span id="cb121-54"><a href="#cb121-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"readxl"</span>,<span class="st">"stringr"</span>,<span class="st">"tidyr"</span>,<span class="st">"purrr"</span>,<span class="st">"lubridate"</span>,<span class="st">"rprojroot"</span>,</span>
<span id="cb121-55"><a href="#cb121-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"exactextractr"</span>,<span class="st">"zoo"</span>,<span class="st">"ggplot2"</span>,<span class="st">"viridis"</span>,<span class="st">"mgcv"</span>,<span class="st">"randomForest"</span>,<span class="st">"fields"</span>,<span class="st">"sp"</span>,<span class="st">"deldir"</span>,</span>
<span id="cb121-56"><a href="#cb121-56" aria-hidden="true" tabindex="-1"></a>  <span class="st">"leaflet"</span>,<span class="st">"DT"</span>,<span class="st">"htmltools"</span>,<span class="st">"jsonlite"</span>,<span class="st">"shiny"</span> <span class="co"># viewer deps</span></span>
<span id="cb121-57"><a href="#cb121-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-58"><a href="#cb121-58" aria-hidden="true" tabindex="-1"></a>need <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(pkgs, <span class="fu">rownames</span>(<span class="fu">installed.packages</span>()))</span>
<span id="cb121-59"><a href="#cb121-59" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(need)) <span class="fu">install.packages</span>(need, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-60"><a href="#cb121-60" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(pkgs, <span class="cf">function</span>(p) <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(p, <span class="at">character.only =</span> <span class="cn">TRUE</span>))))</span>
<span id="cb121-61"><a href="#cb121-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-62"><a href="#cb121-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-65"><a href="#cb121-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-66"><a href="#cb121-66" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: helpers</span></span>
<span id="cb121-67"><a href="#cb121-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Small utilities (kept identical to your working script where applicable)</span></span>
<span id="cb121-68"><a href="#cb121-68" aria-hidden="true" tabindex="-1"></a><span class="co"># SpatRaster sicher "pinnen" (Datei-basiert) und als gültiges Objekt zurückgeben</span></span>
<span id="cb121-69"><a href="#cb121-69" aria-hidden="true" tabindex="-1"></a>.pin_rast <span class="ot">&lt;-</span> <span class="cf">function</span>(r, <span class="at">crs =</span> <span class="cn">NULL</span>, <span class="at">dir =</span> <span class="cn">NULL</span>, <span class="at">name =</span> <span class="st">"pinned"</span>) {</span>
<span id="cb121-70"><a href="#cb121-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">inherits</span>(r, <span class="st">"SpatRaster"</span>))</span>
<span id="cb121-71"><a href="#cb121-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(dir)) dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">getwd</span>(), <span class="st">"run_cache"</span>)</span>
<span id="cb121-72"><a href="#cb121-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(dir)) <span class="fu">dir.create</span>(dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-73"><a href="#cb121-73" aria-hidden="true" tabindex="-1"></a>  f <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dir, <span class="fu">paste0</span>(name, <span class="st">".tif"</span>))</span>
<span id="cb121-74"><a href="#cb121-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># immer schreiben → garantiert datei-gestützt und voll materialisiert</span></span>
<span id="cb121-75"><a href="#cb121-75" aria-hidden="true" tabindex="-1"></a>  terra<span class="sc">::</span><span class="fu">writeRaster</span>(r, f, <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-76"><a href="#cb121-76" aria-hidden="true" tabindex="-1"></a>  rp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(f)</span>
<span id="cb121-77"><a href="#cb121-77" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(crs)) {</span>
<span id="cb121-78"><a href="#cb121-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># nur projezieren, wenn noch nicht identisch</span></span>
<span id="cb121-79"><a href="#cb121-79" aria-hidden="true" tabindex="-1"></a>    same <span class="ot">&lt;-</span> <span class="fu">try</span>(terra<span class="sc">::</span><span class="fu">crs</span>(rp, <span class="at">proj=</span><span class="cn">TRUE</span>) <span class="sc">==</span> <span class="fu">as.character</span>(crs), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-80"><a href="#cb121-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">isTRUE</span>(same)) rp <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">project</span>(rp, <span class="fu">as.character</span>(crs), <span class="at">method =</span> <span class="st">"near"</span>)</span>
<span id="cb121-81"><a href="#cb121-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-82"><a href="#cb121-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sanity check</span></span>
<span id="cb121-83"><a href="#cb121-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(rp))</span>
<span id="cb121-84"><a href="#cb121-84" aria-hidden="true" tabindex="-1"></a>  rp</span>
<span id="cb121-85"><a href="#cb121-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-86"><a href="#cb121-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-87"><a href="#cb121-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Prüfer: „lebt“ der Pointer?</span></span>
<span id="cb121-88"><a href="#cb121-88" aria-hidden="true" tabindex="-1"></a>.is_alive_spatr <span class="ot">&lt;-</span> <span class="cf">function</span>(r) {</span>
<span id="cb121-89"><a href="#cb121-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inherits</span>(r, <span class="st">"SpatRaster"</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">inherits</span>(<span class="fu">try</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(r), <span class="at">silent =</span> <span class="cn">TRUE</span>), <span class="st">"try-error"</span>)</span>
<span id="cb121-90"><a href="#cb121-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-91"><a href="#cb121-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-92"><a href="#cb121-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Safe, URL-friendly file slug</span></span>
<span id="cb121-93"><a href="#cb121-93" aria-hidden="true" tabindex="-1"></a>slug <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { </span>
<span id="cb121-94"><a href="#cb121-94" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^0-9A-Za-z_-]+"</span>,<span class="st">"-"</span>, x)</span>
<span id="cb121-95"><a href="#cb121-95" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"-+"</span>,<span class="st">"-"</span>, x)</span>
<span id="cb121-96"><a href="#cb121-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gsub</span>(<span class="st">"(^-|-$)"</span>,<span class="st">""</span>, x)</span>
<span id="cb121-97"><a href="#cb121-97" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-98"><a href="#cb121-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-99"><a href="#cb121-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Human-readable time labels from AYYYY... keys</span></span>
<span id="cb121-100"><a href="#cb121-100" aria-hidden="true" tabindex="-1"></a>pretty_time <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb121-101"><a href="#cb121-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vapply</span>(x, <span class="cf">function</span>(s) {</span>
<span id="cb121-102"><a href="#cb121-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d{14}$"</span>, s)) {</span>
<span id="cb121-103"><a href="#cb121-103" aria-hidden="true" tabindex="-1"></a>      ts <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(<span class="fu">substr</span>(s, <span class="dv">2</span>, <span class="dv">15</span>), <span class="at">format =</span> <span class="st">"%Y%m%d%H%M%S"</span>, <span class="at">tz =</span> <span class="st">"UTC"</span>)</span>
<span id="cb121-104"><a href="#cb121-104" aria-hidden="true" tabindex="-1"></a>      <span class="fu">format</span>(ts, <span class="st">"%Y-%m-%d %H:%M"</span>)</span>
<span id="cb121-105"><a href="#cb121-105" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d{8}(_D)?$"</span>, s)) {</span>
<span id="cb121-106"><a href="#cb121-106" aria-hidden="true" tabindex="-1"></a>      ts <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="fu">substr</span>(s, <span class="dv">2</span>, <span class="dv">9</span>), <span class="at">format =</span> <span class="st">"%Y%m%d"</span>)</span>
<span id="cb121-107"><a href="#cb121-107" aria-hidden="true" tabindex="-1"></a>      <span class="fu">format</span>(ts, <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb121-108"><a href="#cb121-108" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> s</span>
<span id="cb121-109"><a href="#cb121-109" aria-hidden="true" tabindex="-1"></a>  }, <span class="fu">character</span>(<span class="dv">1</span>))</span>
<span id="cb121-110"><a href="#cb121-110" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-111"><a href="#cb121-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-112"><a href="#cb121-112" aria-hidden="true" tabindex="-1"></a><span class="co"># Pick the most data-dense time-slice (max number of finite observations)</span></span>
<span id="cb121-113"><a href="#cb121-113" aria-hidden="true" tabindex="-1"></a>pick_densest_index <span class="ot">&lt;-</span> <span class="cf">function</span>(sf_wide, var_names) {</span>
<span id="cb121-114"><a href="#cb121-114" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">&lt;-</span> <span class="fu">sapply</span>(var_names, <span class="cf">function</span>(v) <span class="fu">sum</span>(<span class="fu">is.finite</span>(sf_wide[[v]])))</span>
<span id="cb121-115"><a href="#cb121-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which.max</span>(nn)</span>
<span id="cb121-116"><a href="#cb121-116" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-117"><a href="#cb121-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-118"><a href="#cb121-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Build figure descriptions (viewer)</span></span>
<span id="cb121-119"><a href="#cb121-119" aria-hidden="true" tabindex="-1"></a>build_explanations <span class="ot">&lt;-</span> <span class="cf">function</span>(fig_dir, pick_ts) {</span>
<span id="cb121-120"><a href="#cb121-120" aria-hidden="true" tabindex="-1"></a>  ts_label <span class="ot">&lt;-</span> <span class="fu">slug</span>(<span class="fu">pretty_time</span>(pick_ts))</span>
<span id="cb121-121"><a href="#cb121-121" aria-hidden="true" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb121-122"><a href="#cb121-122" aria-hidden="true" tabindex="-1"></a>    <span class="st">"timeseries_panel_grid.png"</span>,</span>
<span id="cb121-123"><a href="#cb121-123" aria-hidden="true" tabindex="-1"></a>    <span class="st">"timeseries_panel_grid.pdf"</span>,</span>
<span id="cb121-124"><a href="#cb121-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"u_curve_%s.png"</span>, ts_label),</span>
<span id="cb121-125"><a href="#cb121-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"u_curve_extras_%s.png"</span>, ts_label),</span>
<span id="cb121-126"><a href="#cb121-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"benchmark_%s.png"</span>, ts_label),</span>
<span id="cb121-127"><a href="#cb121-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"benchmark_extras_%s.png"</span>, ts_label)</span>
<span id="cb121-128"><a href="#cb121-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-129"><a href="#cb121-129" aria-hidden="true" tabindex="-1"></a>  paths <span class="ot">&lt;-</span> <span class="fu">file.path</span>(fig_dir, files)</span>
<span id="cb121-130"><a href="#cb121-130" aria-hidden="true" tabindex="-1"></a>  desc  <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb121-131"><a href="#cb121-131" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Per-timestep KED previews; dots=stations; red=plot boundary."</span>,</span>
<span id="cb121-132"><a href="#cb121-132" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Same as PNG, vector PDF."</span>,</span>
<span id="cb121-133"><a href="#cb121-133" aria-hidden="true" tabindex="-1"></a>    <span class="st">"U-curve for tuning R via block-CV (drift-only)."</span>,</span>
<span id="cb121-134"><a href="#cb121-134" aria-hidden="true" tabindex="-1"></a>    <span class="st">"U-curve with extra predictors."</span>,</span>
<span id="cb121-135"><a href="#cb121-135" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Method comparison at R* (lower RMSE is better)."</span>,</span>
<span id="cb121-136"><a href="#cb121-136" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Benchmark with extras at R*."</span></span>
<span id="cb121-137"><a href="#cb121-137" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-138"><a href="#cb121-138" aria-hidden="true" tabindex="-1"></a>  keep <span class="ot">&lt;-</span> <span class="fu">file.exists</span>(paths)</span>
<span id="cb121-139"><a href="#cb121-139" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.list</span>(desc[keep]); <span class="fu">names</span>(out) <span class="ot">&lt;-</span> <span class="fu">basename</span>(paths[keep])</span>
<span id="cb121-140"><a href="#cb121-140" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb121-141"><a href="#cb121-141" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-142"><a href="#cb121-142" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-143"><a href="#cb121-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-146"><a href="#cb121-146" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-147"><a href="#cb121-147" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: reporting-helpers</span></span>
<span id="cb121-148"><a href="#cb121-148" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb121-149"><a href="#cb121-149" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb121-150"><a href="#cb121-150" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb121-151"><a href="#cb121-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-152"><a href="#cb121-152" aria-hidden="true" tabindex="-1"></a>.is_html <span class="ot">&lt;-</span> <span class="cf">function</span>() knitr<span class="sc">::</span><span class="fu">is_html_output</span>()</span>
<span id="cb121-153"><a href="#cb121-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-154"><a href="#cb121-154" aria-hidden="true" tabindex="-1"></a>.show_table <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">caption =</span> <span class="st">""</span>) {</span>
<span id="cb121-155"><a href="#cb121-155" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">isTRUE</span>(<span class="fu">.is_html</span>())) {</span>
<span id="cb121-156"><a href="#cb121-156" aria-hidden="true" tabindex="-1"></a>    DT<span class="sc">::</span><span class="fu">datatable</span>(</span>
<span id="cb121-157"><a href="#cb121-157" aria-hidden="true" tabindex="-1"></a>      df, <span class="at">rownames =</span> <span class="cn">FALSE</span>,</span>
<span id="cb121-158"><a href="#cb121-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">caption =</span> htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">caption</span>(</span>
<span id="cb121-159"><a href="#cb121-159" aria-hidden="true" tabindex="-1"></a>        <span class="at">style=</span><span class="st">'caption-side: top; text-align: left;'</span>, caption</span>
<span id="cb121-160"><a href="#cb121-160" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb121-161"><a href="#cb121-161" aria-hidden="true" tabindex="-1"></a>      <span class="at">options =</span> <span class="fu">list</span>(<span class="at">pageLength =</span> <span class="dv">10</span>, <span class="at">dom =</span> <span class="st">"tip"</span>)</span>
<span id="cb121-162"><a href="#cb121-162" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb121-163"><a href="#cb121-163" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb121-164"><a href="#cb121-164" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(df, <span class="at">caption =</span> caption)</span>
<span id="cb121-165"><a href="#cb121-165" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-166"><a href="#cb121-166" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-167"><a href="#cb121-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-168"><a href="#cb121-168" aria-hidden="true" tabindex="-1"></a>.kv_tbl <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb121-169"><a href="#cb121-169" aria-hidden="true" tabindex="-1"></a>  li <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb121-170"><a href="#cb121-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb121-171"><a href="#cb121-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">Key   =</span> <span class="fu">names</span>(li),</span>
<span id="cb121-172"><a href="#cb121-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">Value =</span> <span class="fu">vapply</span>(li, <span class="cf">function</span>(x) <span class="fu">paste</span>(<span class="fu">capture.output</span>(<span class="fu">print</span>(x)), <span class="at">collapse =</span> <span class="st">" "</span>), <span class="fu">character</span>(<span class="dv">1</span>)),</span>
<span id="cb121-173"><a href="#cb121-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb121-174"><a href="#cb121-174" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-175"><a href="#cb121-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-176"><a href="#cb121-176" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-177"><a href="#cb121-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-178"><a href="#cb121-178" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Why this matters:** using fine pixels for scale estimation will cap $R$ at a few pixels, resulting in the “10 m fallback”. Keep </span><span class="in">`DEM_scale`</span><span class="at"> at a realistic native/coarser resolution for L/R.</span></span>
<span id="cb121-179"><a href="#cb121-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-180"><a href="#cb121-180" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1) Project &amp; Paths</span></span>
<span id="cb121-181"><a href="#cb121-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-184"><a href="#cb121-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-185"><a href="#cb121-185" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: paths</span></span>
<span id="cb121-186"><a href="#cb121-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust project root finder and paths</span></span>
<span id="cb121-187"><a href="#cb121-187" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> rprojroot<span class="sc">::</span><span class="fu">find_rstudio_root_file</span>()</span>
<span id="cb121-188"><a href="#cb121-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-189"><a href="#cb121-189" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(wd, <span class="st">"reader/all_functions_1.R"</span>))   <span class="co"># consolidated toolkit</span></span>
<span id="cb121-190"><a href="#cb121-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-191"><a href="#cb121-191" aria-hidden="true" tabindex="-1"></a><span class="co">#fn_DTM        &lt;- file.path(wd, "reader/data_2024/copernicus_DEM.tif")</span></span>
<span id="cb121-192"><a href="#cb121-192" aria-hidden="true" tabindex="-1"></a>fn_DTM        <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/DEM.tif"</span>)</span>
<span id="cb121-193"><a href="#cb121-193" aria-hidden="true" tabindex="-1"></a>fn_stations   <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/stations_prelim_modifiziert.gpkg"</span>)</span>
<span id="cb121-194"><a href="#cb121-194" aria-hidden="true" tabindex="-1"></a>fn_area       <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/plot.shp"</span>)</span>
<span id="cb121-195"><a href="#cb121-195" aria-hidden="true" tabindex="-1"></a>fn_temp_FC29  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/all_GW1000A-WIFIFC29.xlsx"</span>)</span>
<span id="cb121-196"><a href="#cb121-196" aria-hidden="true" tabindex="-1"></a>fn_temp_DB2F  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/all_GW1000A-WIFIDB2F.xlsx"</span>)</span>
<span id="cb121-197"><a href="#cb121-197" aria-hidden="true" tabindex="-1"></a>cleandata_rds <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/data_2024/climdata.RDS"</span>)</span>
<span id="cb121-198"><a href="#cb121-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-199"><a href="#cb121-199" aria-hidden="true" tabindex="-1"></a>out_dir    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"reader/interpolated"</span>)</span>
<span id="cb121-200"><a href="#cb121-200" aria-hidden="true" tabindex="-1"></a>fig_dir    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"fig"</span>)</span>
<span id="cb121-201"><a href="#cb121-201" aria-hidden="true" tabindex="-1"></a>method_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"methods_compare"</span>)</span>
<span id="cb121-202"><a href="#cb121-202" aria-hidden="true" tabindex="-1"></a>report_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"report"</span>)</span>
<span id="cb121-203"><a href="#cb121-203" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (d <span class="cf">in</span> <span class="fu">c</span>(out_dir, fig_dir, method_dir, report_dir)) <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(d)) <span class="fu">dir.create</span>(d, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-204"><a href="#cb121-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-205"><a href="#cb121-205" aria-hidden="true" tabindex="-1"></a><span class="co"># CRS</span></span>
<span id="cb121-206"><a href="#cb121-206" aria-hidden="true" tabindex="-1"></a>epsg <span class="ot">&lt;-</span> <span class="st">"EPSG:32633"</span>  <span class="co"># UTM zone 33N</span></span>
<span id="cb121-207"><a href="#cb121-207" aria-hidden="true" tabindex="-1"></a>sf_crs_utm33 <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_crs</span>(epsg)</span>
<span id="cb121-208"><a href="#cb121-208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-209"><a href="#cb121-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-210"><a href="#cb121-210" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2) Base Data &amp; DEM Strategy</span></span>
<span id="cb121-211"><a href="#cb121-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-214"><a href="#cb121-214" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-215"><a href="#cb121-215" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dem-and-areas</span></span>
<span id="cb121-216"><a href="#cb121-216" aria-hidden="true" tabindex="-1"></a><span class="co"># DEMs</span></span>
<span id="cb121-217"><a href="#cb121-217" aria-hidden="true" tabindex="-1"></a>DEM_scale  <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fn_DTM) <span class="sc">|&gt;</span> terra<span class="sc">::</span><span class="fu">project</span>(epsg)</span>
<span id="cb121-218"><a href="#cb121-218" aria-hidden="true" tabindex="-1"></a>DEM_scale  <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(DEM_scale, <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">20</span>))  <span class="co"># coarsen ~20–25 m (as in your working code)</span></span>
<span id="cb121-219"><a href="#cb121-219" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(DEM_scale) <span class="ot">&lt;-</span> <span class="st">"altitude"</span></span>
<span id="cb121-220"><a href="#cb121-220" aria-hidden="true" tabindex="-1"></a>DEM_render <span class="ot">&lt;-</span> DEM_scale <span class="sc">|&gt;</span> terra<span class="sc">::</span><span class="fu">aggregate</span>(<span class="at">fact =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>))  <span class="co"># for rendering products</span></span>
<span id="cb121-221"><a href="#cb121-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-222"><a href="#cb121-222" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DEM_scale res (m): "</span>, <span class="fu">paste</span>(terra<span class="sc">::</span><span class="fu">res</span>(DEM_scale),  <span class="at">collapse=</span><span class="st">" x "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-223"><a href="#cb121-223" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"DEM_render res (m):"</span>, <span class="fu">paste</span>(terra<span class="sc">::</span><span class="fu">res</span>(DEM_render), <span class="at">collapse=</span><span class="st">" x "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-224"><a href="#cb121-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-225"><a href="#cb121-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Stations and plot boundary → same CRS</span></span>
<span id="cb121-226"><a href="#cb121-226" aria-hidden="true" tabindex="-1"></a>stations_pos <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(fn_stations, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf_crs_utm33)</span>
<span id="cb121-227"><a href="#cb121-227" aria-hidden="true" tabindex="-1"></a>plot_area    <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(fn_area, <span class="at">quiet =</span> <span class="cn">TRUE</span>)     <span class="sc">|&gt;</span> sf<span class="sc">::</span><span class="fu">st_transform</span>(sf_crs_utm33) <span class="sc">|&gt;</span> sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb121-228"><a href="#cb121-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-229"><a href="#cb121-229" aria-hidden="true" tabindex="-1"></a><span class="co"># Altitude from DEM_scale (not the upsampled one)</span></span>
<span id="cb121-230"><a href="#cb121-230" aria-hidden="true" tabindex="-1"></a>stations_pos <span class="ot">&lt;-</span> stations_pos <span class="sc">%&gt;%</span></span>
<span id="cb121-231"><a href="#cb121-231" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">altitude =</span> exactextractr<span class="sc">::</span><span class="fu">exact_extract</span>(DEM_scale, sf<span class="sc">::</span><span class="fu">st_buffer</span>(stations_pos, <span class="dv">1</span>), <span class="st">"mean"</span>))</span>
<span id="cb121-232"><a href="#cb121-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-233"><a href="#cb121-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-236"><a href="#cb121-236" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-237"><a href="#cb121-237" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dem-summary</span></span>
<span id="cb121-238"><a href="#cb121-238" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb121-239"><a href="#cb121-239" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb121-240"><a href="#cb121-240" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb121-241"><a href="#cb121-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-242"><a href="#cb121-242" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"DEM_scale"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"DEM_render"</span>)) {</span>
<span id="cb121-243"><a href="#cb121-243" aria-hidden="true" tabindex="-1"></a>  dem_info <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb121-244"><a href="#cb121-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">DEM    =</span> <span class="fu">c</span>(<span class="st">"DEM_scale"</span>,<span class="st">"DEM_render"</span>),</span>
<span id="cb121-245"><a href="#cb121-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_x  =</span> <span class="fu">c</span>(terra<span class="sc">::</span><span class="fu">res</span>(DEM_scale)[<span class="dv">1</span>], terra<span class="sc">::</span><span class="fu">res</span>(DEM_render)[<span class="dv">1</span>]),</span>
<span id="cb121-246"><a href="#cb121-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">res_y  =</span> <span class="fu">c</span>(terra<span class="sc">::</span><span class="fu">res</span>(DEM_scale)[<span class="dv">2</span>], terra<span class="sc">::</span><span class="fu">res</span>(DEM_render)[<span class="dv">2</span>]),</span>
<span id="cb121-247"><a href="#cb121-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol   =</span> <span class="fu">c</span>(<span class="fu">ncol</span>(DEM_scale), <span class="fu">ncol</span>(DEM_render)),</span>
<span id="cb121-248"><a href="#cb121-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow   =</span> <span class="fu">c</span>(<span class="fu">nrow</span>(DEM_scale), <span class="fu">nrow</span>(DEM_render)),</span>
<span id="cb121-249"><a href="#cb121-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs    =</span> <span class="fu">c</span>(terra<span class="sc">::</span><span class="fu">crs</span>(DEM_scale), terra<span class="sc">::</span><span class="fu">crs</span>(DEM_render)),</span>
<span id="cb121-250"><a href="#cb121-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb121-251"><a href="#cb121-251" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-252"><a href="#cb121-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.show_table</span>(dem_info, <span class="st">"DEM summary (resolution, dimensions, CRS)"</span>)</span>
<span id="cb121-253"><a href="#cb121-253" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb121-254"><a href="#cb121-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"DEM objects not found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-255"><a href="#cb121-255" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-256"><a href="#cb121-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-257"><a href="#cb121-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-258"><a href="#cb121-258" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3) Ecowitt Ingestion, Cleaning, Aggregation</span></span>
<span id="cb121-259"><a href="#cb121-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-262"><a href="#cb121-262" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-263"><a href="#cb121-263" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ingest-and-clean</span></span>
<span id="cb121-264"><a href="#cb121-264" aria-hidden="true" tabindex="-1"></a>temp_FC29 <span class="ot">&lt;-</span> <span class="fu">extract_ecowitt_core_vars</span>(fn_temp_FC29)</span>
<span id="cb121-265"><a href="#cb121-265" aria-hidden="true" tabindex="-1"></a>temp_DB2F <span class="ot">&lt;-</span> <span class="fu">extract_ecowitt_core_vars</span>(fn_temp_DB2F)</span>
<span id="cb121-266"><a href="#cb121-266" aria-hidden="true" tabindex="-1"></a>t_rh_all  <span class="ot">&lt;-</span> <span class="fu">merge_ecowitt_logger_vars</span>(temp_FC29, temp_DB2F)</span>
<span id="cb121-267"><a href="#cb121-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-268"><a href="#cb121-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean display names and map to verbose station names</span></span>
<span id="cb121-269"><a href="#cb121-269" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (meas <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"temperature"</span>,<span class="st">"humidity"</span>)) {</span>
<span id="cb121-270"><a href="#cb121-270" aria-hidden="true" tabindex="-1"></a>  t_rh_all[[meas]] <span class="ot">&lt;-</span> t_rh_all[[meas]] <span class="sc">%&gt;%</span></span>
<span id="cb121-271"><a href="#cb121-271" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">to_verbose</span>(.x, <span class="fu">ifelse</span>(meas<span class="sc">==</span><span class="st">"temperature"</span>,<span class="st">"Temperature"</span>,<span class="st">"Humidity"</span>)), <span class="sc">-</span>Time) <span class="sc">%&gt;%</span></span>
<span id="cb121-272"><a href="#cb121-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">clean_names</span>()</span>
<span id="cb121-273"><a href="#cb121-273" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-274"><a href="#cb121-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-275"><a href="#cb121-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate to 3-hour steps</span></span>
<span id="cb121-276"><a href="#cb121-276" aria-hidden="true" tabindex="-1"></a>temp_agg <span class="ot">&lt;-</span> t_rh_all<span class="sc">$</span>temperature <span class="sc">%&gt;%</span></span>
<span id="cb121-277"><a href="#cb121-277" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">time =</span> lubridate<span class="sc">::</span><span class="fu">floor_date</span>(Time, <span class="st">"3 hours"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb121-278"><a href="#cb121-278" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb121-279"><a href="#cb121-279" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb121-280"><a href="#cb121-280" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(temp_agg) <span class="ot">&lt;-</span> <span class="fu">clean_ids</span>(<span class="fu">names</span>(temp_agg))</span>
<span id="cb121-281"><a href="#cb121-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-282"><a href="#cb121-282" aria-hidden="true" tabindex="-1"></a><span class="co"># long → wide matrix: station rows, time columns</span></span>
<span id="cb121-283"><a href="#cb121-283" aria-hidden="true" tabindex="-1"></a>temp_matrix <span class="ot">&lt;-</span> temp_agg <span class="sc">%&gt;%</span></span>
<span id="cb121-284"><a href="#cb121-284" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>time, <span class="at">names_to =</span> <span class="st">"stationid"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb121-285"><a href="#cb121-285" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> time, <span class="at">values_from =</span> value)</span>
<span id="cb121-286"><a href="#cb121-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-287"><a href="#cb121-287" aria-hidden="true" tabindex="-1"></a><span class="co"># Join to station geometry and altitude</span></span>
<span id="cb121-288"><a href="#cb121-288" aria-hidden="true" tabindex="-1"></a>stations_pos <span class="ot">&lt;-</span> stations_pos <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">stationid =</span> <span class="fu">to_verbose</span>(stationid))</span>
<span id="cb121-289"><a href="#cb121-289" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">left_join</span>(stations_pos, temp_matrix, <span class="at">by =</span> <span class="st">"stationid"</span>)</span>
<span id="cb121-290"><a href="#cb121-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-291"><a href="#cb121-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Hygiene</span></span>
<span id="cb121-292"><a href="#cb121-292" aria-hidden="true" tabindex="-1"></a>stations_pos<span class="sc">$</span>stationid <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">(℃</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(％</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">%</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, stations_pos<span class="sc">$</span>stationid)</span>
<span id="cb121-293"><a href="#cb121-293" aria-hidden="true" tabindex="-1"></a>m<span class="sc">$</span>stationid            <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">(℃</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(％</span><span class="sc">\\</span><span class="st">)|</span><span class="sc">\\</span><span class="st">(</span><span class="sc">\\</span><span class="st">%</span><span class="sc">\\</span><span class="st">)"</span>, <span class="st">""</span>, m<span class="sc">$</span>stationid)</span>
<span id="cb121-294"><a href="#cb121-294" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(m)               <span class="ot">&lt;-</span> <span class="fu">fix_names</span>(<span class="fu">names</span>(m))</span>
<span id="cb121-295"><a href="#cb121-295" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(m, cleandata_rds)</span>
<span id="cb121-296"><a href="#cb121-296" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-297"><a href="#cb121-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-300"><a href="#cb121-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-301"><a href="#cb121-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: stations-area-summary</span></span>
<span id="cb121-302"><a href="#cb121-302" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb121-303"><a href="#cb121-303" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb121-304"><a href="#cb121-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-305"><a href="#cb121-305" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"stations_pos"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"plot_area"</span>)) {</span>
<span id="cb121-306"><a href="#cb121-306" aria-hidden="true" tabindex="-1"></a>  s_info <span class="ot">&lt;-</span> <span class="fu">.kv_tbl</span>(</span>
<span id="cb121-307"><a href="#cb121-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_stations =</span> <span class="fu">nrow</span>(stations_pos),</span>
<span id="cb121-308"><a href="#cb121-308" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs        =</span> <span class="fu">as.character</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(stations_pos)<span class="sc">$</span>input),</span>
<span id="cb121-309"><a href="#cb121-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_ids =</span> <span class="fu">paste</span>(utils<span class="sc">::</span><span class="fu">head</span>(stations_pos<span class="sc">$</span>stationid <span class="sc">%||%</span> stations_pos<span class="sc">$</span>StationID, <span class="dv">8</span>), <span class="at">collapse =</span> <span class="st">", "</span>)</span>
<span id="cb121-310"><a href="#cb121-310" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-311"><a href="#cb121-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.show_table</span>(s_info, <span class="st">"Stations summary"</span>)</span>
<span id="cb121-312"><a href="#cb121-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-313"><a href="#cb121-313" aria-hidden="true" tabindex="-1"></a>  a_info <span class="ot">&lt;-</span> <span class="fu">.kv_tbl</span>(</span>
<span id="cb121-314"><a href="#cb121-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_crs =</span> <span class="fu">as.character</span>(sf<span class="sc">::</span><span class="fu">st_crs</span>(plot_area)<span class="sc">$</span>input),</span>
<span id="cb121-315"><a href="#cb121-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_bbox=</span> <span class="fu">paste</span>(<span class="fu">signif</span>(<span class="fu">as.numeric</span>(sf<span class="sc">::</span><span class="fu">st_bbox</span>(plot_area)), <span class="dv">4</span>), <span class="at">collapse =</span> <span class="st">" / "</span>)</span>
<span id="cb121-316"><a href="#cb121-316" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-317"><a href="#cb121-317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.show_table</span>(a_info, <span class="st">"Plot boundary summary"</span>)</span>
<span id="cb121-318"><a href="#cb121-318" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb121-319"><a href="#cb121-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"stations_pos / plot_area not available.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-320"><a href="#cb121-320" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-321"><a href="#cb121-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-322"><a href="#cb121-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-323"><a href="#cb121-323" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4) Interpolation Preview (Per-Timestep KED)</span></span>
<span id="cb121-324"><a href="#cb121-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-327"><a href="#cb121-327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-328"><a href="#cb121-328" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ked-preview</span></span>
<span id="cb121-329"><a href="#cb121-329" aria-hidden="true" tabindex="-1"></a>min_pts <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb121-330"><a href="#cb121-330" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">grep</span>(<span class="st">"^A</span><span class="sc">\\</span><span class="st">d{8,14}"</span>, <span class="fu">names</span>(m), <span class="at">value =</span> <span class="cn">TRUE</span>))</span>
<span id="cb121-331"><a href="#cb121-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-332"><a href="#cb121-332" aria-hidden="true" tabindex="-1"></a>kriged_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(vars, <span class="cf">function</span>(v) {</span>
<span id="cb121-333"><a href="#cb121-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">interpolate_kriging</span>(v, m, DEM_render, <span class="at">output_dir =</span> out_dir, <span class="at">label =</span> <span class="st">"pretty"</span>)</span>
<span id="cb121-334"><a href="#cb121-334" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb121-335"><a href="#cb121-335" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(kriged_list) <span class="ot">&lt;-</span> vars</span>
<span id="cb121-336"><a href="#cb121-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-337"><a href="#cb121-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-340"><a href="#cb121-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-341"><a href="#cb121-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: panel</span></span>
<span id="cb121-342"><a href="#cb121-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Shared color scale across all timestamps</span></span>
<span id="cb121-343"><a href="#cb121-343" aria-hidden="true" tabindex="-1"></a>panel <span class="ot">&lt;-</span> <span class="fu">timeseries_panel</span>(</span>
<span id="cb121-344"><a href="#cb121-344" aria-hidden="true" tabindex="-1"></a>  <span class="at">kriged_list        =</span> kriged_list,</span>
<span id="cb121-345"><a href="#cb121-345" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot_area          =</span> plot_area,</span>
<span id="cb121-346"><a href="#cb121-346" aria-hidden="true" tabindex="-1"></a>  <span class="at">stations_pos       =</span> stations_pos,</span>
<span id="cb121-347"><a href="#cb121-347" aria-hidden="true" tabindex="-1"></a>  <span class="at">cells_target       =</span> <span class="dv">150000</span>,</span>
<span id="cb121-348"><a href="#cb121-348" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_cols           =</span> <span class="dv">4</span>,</span>
<span id="cb121-349"><a href="#cb121-349" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_pretty_time  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb121-350"><a href="#cb121-350" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_png            =</span> <span class="fu">file.path</span>(fig_dir, <span class="st">"timeseries_panel_grid.png"</span>),</span>
<span id="cb121-351"><a href="#cb121-351" aria-hidden="true" tabindex="-1"></a>  <span class="at">out_pdf            =</span> <span class="fu">file.path</span>(fig_dir, <span class="st">"timeseries_panel_grid.pdf"</span>),</span>
<span id="cb121-352"><a href="#cb121-352" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill_label         =</span> <span class="st">"Temperature"</span></span>
<span id="cb121-353"><a href="#cb121-353" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-354"><a href="#cb121-354" aria-hidden="true" tabindex="-1"></a>panel<span class="sc">$</span>plot</span>
<span id="cb121-355"><a href="#cb121-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-356"><a href="#cb121-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-357"><a href="#cb121-357" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5) Method Comparison for Densest Timestamp (Working Code)</span></span>
<span id="cb121-358"><a href="#cb121-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-361"><a href="#cb121-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-362"><a href="#cb121-362" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: run-one</span></span>
<span id="cb121-363"><a href="#cb121-363" aria-hidden="true" tabindex="-1"></a><span class="co"># Densest timestamp</span></span>
<span id="cb121-364"><a href="#cb121-364" aria-hidden="true" tabindex="-1"></a>pick_idx <span class="ot">&lt;-</span> <span class="fu">pick_densest_index</span>(m, vars)</span>
<span id="cb121-365"><a href="#cb121-365" aria-hidden="true" tabindex="-1"></a>pick_ts  <span class="ot">&lt;-</span> <span class="fu">names</span>(m)[pick_idx]</span>
<span id="cb121-366"><a href="#cb121-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-367"><a href="#cb121-367" aria-hidden="true" tabindex="-1"></a><span class="co"># Extra predictors (kept as in your working code)</span></span>
<span id="cb121-368"><a href="#cb121-368" aria-hidden="true" tabindex="-1"></a>extra_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb121-369"><a href="#cb121-369" aria-hidden="true" tabindex="-1"></a>  <span class="at">slope  =</span> terra<span class="sc">::</span><span class="fu">terrain</span>(DEM_scale, <span class="at">v =</span> <span class="st">"slope"</span>,  <span class="at">unit =</span> <span class="st">"degrees"</span>),</span>
<span id="cb121-370"><a href="#cb121-370" aria-hidden="true" tabindex="-1"></a>  <span class="at">aspect =</span> terra<span class="sc">::</span><span class="fu">terrain</span>(DEM_scale, <span class="at">v =</span> <span class="st">"aspect"</span>),</span>
<span id="cb121-371"><a href="#cb121-371" aria-hidden="true" tabindex="-1"></a>  <span class="at">tri    =</span> terra<span class="sc">::</span><span class="fu">terrain</span>(DEM_scale, <span class="at">v =</span> <span class="st">"TRI"</span>)</span>
<span id="cb121-372"><a href="#cb121-372" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-373"><a href="#cb121-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-374"><a href="#cb121-374" aria-hidden="true" tabindex="-1"></a><span class="co"># One timestamp (densest), with extras</span></span>
<span id="cb121-375"><a href="#cb121-375" aria-hidden="true" tabindex="-1"></a>res_one <span class="ot">&lt;-</span> <span class="fu">run_one</span>(</span>
<span id="cb121-376"><a href="#cb121-376" aria-hidden="true" tabindex="-1"></a>  <span class="at">v           =</span> vars[[pick_idx]],</span>
<span id="cb121-377"><a href="#cb121-377" aria-hidden="true" tabindex="-1"></a>  <span class="at">m           =</span> m,</span>
<span id="cb121-378"><a href="#cb121-378" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEM_render  =</span> DEM_render,</span>
<span id="cb121-379"><a href="#cb121-379" aria-hidden="true" tabindex="-1"></a>  <span class="at">DEM_scale   =</span> DEM_scale,</span>
<span id="cb121-380"><a href="#cb121-380" aria-hidden="true" tabindex="-1"></a>  <span class="at">method_dir  =</span> method_dir,</span>
<span id="cb121-381"><a href="#cb121-381" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig_dir     =</span> fig_dir,</span>
<span id="cb121-382"><a href="#cb121-382" aria-hidden="true" tabindex="-1"></a>  <span class="at">report_dir  =</span> report_dir,</span>
<span id="cb121-383"><a href="#cb121-383" aria-hidden="true" tabindex="-1"></a>  <span class="at">extra_preds =</span> extra_list,</span>
<span id="cb121-384"><a href="#cb121-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">save_figs   =</span> <span class="cn">TRUE</span></span>
<span id="cb121-385"><a href="#cb121-385" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-386"><a href="#cb121-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-387"><a href="#cb121-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-388"><a href="#cb121-388" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6) (Optional) Compute All Time Steps</span></span>
<span id="cb121-389"><a href="#cb121-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-392"><a href="#cb121-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-393"><a href="#cb121-393" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-all</span></span>
<span id="cb121-394"><a href="#cb121-394" aria-hidden="true" tabindex="-1"></a>compute_all <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb121-395"><a href="#cb121-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-396"><a href="#cb121-396" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">isTRUE</span>(compute_all)) {</span>
<span id="cb121-397"><a href="#cb121-397" aria-hidden="true" tabindex="-1"></a>  req <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"m"</span>,<span class="st">"DEM_render"</span>,<span class="st">"DEM_scale"</span>,<span class="st">"method_dir"</span>,<span class="st">"fig_dir"</span>,<span class="st">"report_dir"</span>)</span>
<span id="cb121-398"><a href="#cb121-398" aria-hidden="true" tabindex="-1"></a>  miss <span class="ot">&lt;-</span> req[<span class="sc">!</span><span class="fu">vapply</span>(req, exists, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="at">inherits =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb121-399"><a href="#cb121-399" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(miss)) <span class="fu">stop</span>(<span class="st">"Fehlende Objekte im Environment: "</span>, <span class="fu">paste</span>(miss, <span class="at">collapse =</span> <span class="st">", "</span>))</span>
<span id="cb121-400"><a href="#cb121-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-401"><a href="#cb121-401" aria-hidden="true" tabindex="-1"></a>  .best_from_bench <span class="ot">&lt;-</span> <span class="cf">function</span>(bench_obj) {</span>
<span id="cb121-402"><a href="#cb121-402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(bench_obj) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.data.frame</span>(bench_obj<span class="sc">$</span>table) <span class="sc">||</span> <span class="fu">nrow</span>(bench_obj<span class="sc">$</span>table) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb121-403"><a href="#cb121-403" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb121-404"><a href="#cb121-404" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> bench_obj<span class="sc">$</span>table</span>
<span id="cb121-405"><a href="#cb121-405" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> b[<span class="fu">is.finite</span>(b<span class="sc">$</span>RMSE), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb121-406"><a href="#cb121-406" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">nrow</span>(b)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb121-407"><a href="#cb121-407" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> b[<span class="fu">order</span>(b<span class="sc">$</span>RMSE), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb121-408"><a href="#cb121-408" aria-hidden="true" tabindex="-1"></a>    b[<span class="dv">1</span>, <span class="fu">c</span>(<span class="st">"method"</span>,<span class="st">"RMSE"</span>), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb121-409"><a href="#cb121-409" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-410"><a href="#cb121-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-411"><a href="#cb121-411" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">"Starte compute_all für %d Zeitschritte …"</span>, <span class="fu">length</span>(vars)))</span>
<span id="cb121-412"><a href="#cb121-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-413"><a href="#cb121-413" aria-hidden="true" tabindex="-1"></a>  res_all <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">lapply</span>(vars, <span class="cf">function</span>(vv) {</span>
<span id="cb121-414"><a href="#cb121-414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"→ run_one: "</span>, <span class="fu">pretty_time</span>(vv))</span>
<span id="cb121-415"><a href="#cb121-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb121-416"><a href="#cb121-416" aria-hidden="true" tabindex="-1"></a>      <span class="fu">run_one</span>(</span>
<span id="cb121-417"><a href="#cb121-417" aria-hidden="true" tabindex="-1"></a>        <span class="at">v           =</span> vv,</span>
<span id="cb121-418"><a href="#cb121-418" aria-hidden="true" tabindex="-1"></a>        <span class="at">m           =</span> m,</span>
<span id="cb121-419"><a href="#cb121-419" aria-hidden="true" tabindex="-1"></a>        <span class="at">DEM_render  =</span> DEM_render,</span>
<span id="cb121-420"><a href="#cb121-420" aria-hidden="true" tabindex="-1"></a>        <span class="at">DEM_scale   =</span> DEM_scale,</span>
<span id="cb121-421"><a href="#cb121-421" aria-hidden="true" tabindex="-1"></a>        <span class="at">method_dir  =</span> method_dir,</span>
<span id="cb121-422"><a href="#cb121-422" aria-hidden="true" tabindex="-1"></a>        <span class="at">fig_dir     =</span> fig_dir,</span>
<span id="cb121-423"><a href="#cb121-423" aria-hidden="true" tabindex="-1"></a>        <span class="at">report_dir  =</span> report_dir,</span>
<span id="cb121-424"><a href="#cb121-424" aria-hidden="true" tabindex="-1"></a>        <span class="at">extra_preds =</span> extra_list,</span>
<span id="cb121-425"><a href="#cb121-425" aria-hidden="true" tabindex="-1"></a>        <span class="at">save_figs   =</span> <span class="cn">TRUE</span>,</span>
<span id="cb121-426"><a href="#cb121-426" aria-hidden="true" tabindex="-1"></a>        <span class="at">save_tables =</span> <span class="cn">TRUE</span></span>
<span id="cb121-427"><a href="#cb121-427" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb121-428"><a href="#cb121-428" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb121-429"><a href="#cb121-429" aria-hidden="true" tabindex="-1"></a>        <span class="fu">warning</span>(<span class="st">"run_one fehlgeschlagen für "</span>, vv, <span class="st">": "</span>, <span class="fu">conditionMessage</span>(e))</span>
<span id="cb121-430"><a href="#cb121-430" aria-hidden="true" tabindex="-1"></a>        <span class="cn">NULL</span></span>
<span id="cb121-431"><a href="#cb121-431" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb121-432"><a href="#cb121-432" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb121-433"><a href="#cb121-433" aria-hidden="true" tabindex="-1"></a>  }), vars)</span>
<span id="cb121-434"><a href="#cb121-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-435"><a href="#cb121-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(res_all, <span class="fu">file.path</span>(report_dir, <span class="st">"all_results.RDS"</span>))</span>
<span id="cb121-436"><a href="#cb121-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-437"><a href="#cb121-437" aria-hidden="true" tabindex="-1"></a>  summ <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(<span class="fu">names</span>(res_all), <span class="cf">function</span>(k) {</span>
<span id="cb121-438"><a href="#cb121-438" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> res_all[[k]]</span>
<span id="cb121-439"><a href="#cb121-439" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(r)) {</span>
<span id="cb121-440"><a href="#cb121-440" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb121-441"><a href="#cb121-441" aria-hidden="true" tabindex="-1"></a>        <span class="at">ts_key      =</span> k, </span>
<span id="cb121-442"><a href="#cb121-442" aria-hidden="true" tabindex="-1"></a>        <span class="at">stamp       =</span> <span class="fu">pretty_time</span>(k),</span>
<span id="cb121-443"><a href="#cb121-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">R_star      =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb121-444"><a href="#cb121-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">best_source =</span> <span class="cn">NA_character_</span>,  <span class="co"># "no_extras"/"with_extras"</span></span>
<span id="cb121-445"><a href="#cb121-445" aria-hidden="true" tabindex="-1"></a>        <span class="at">best_method =</span> <span class="cn">NA_character_</span>,</span>
<span id="cb121-446"><a href="#cb121-446" aria-hidden="true" tabindex="-1"></a>        <span class="at">best_RMSE   =</span> <span class="cn">NA_real_</span></span>
<span id="cb121-447"><a href="#cb121-447" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb121-448"><a href="#cb121-448" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-449"><a href="#cb121-449" aria-hidden="true" tabindex="-1"></a>    rstar <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(r<span class="sc">$</span>tune<span class="sc">$</span>R_star))</span>
<span id="cb121-450"><a href="#cb121-450" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.finite</span>(rstar)) rstar <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb121-451"><a href="#cb121-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-452"><a href="#cb121-452" aria-hidden="true" tabindex="-1"></a>    b0 <span class="ot">&lt;-</span> <span class="fu">.best_from_bench</span>(r<span class="sc">$</span>bench)</span>
<span id="cb121-453"><a href="#cb121-453" aria-hidden="true" tabindex="-1"></a>    bE <span class="ot">&lt;-</span> <span class="fu">.best_from_bench</span>(r<span class="sc">$</span>bench_ex)</span>
<span id="cb121-454"><a href="#cb121-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-455"><a href="#cb121-455" aria-hidden="true" tabindex="-1"></a>    score0 <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(b0) <span class="sc">&amp;&amp;</span> <span class="fu">isTRUE</span>(<span class="fu">is.finite</span>(b0<span class="sc">$</span>RMSE))) b0<span class="sc">$</span>RMSE <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb121-456"><a href="#cb121-456" aria-hidden="true" tabindex="-1"></a>    scoreE <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(bE) <span class="sc">&amp;&amp;</span> <span class="fu">isTRUE</span>(<span class="fu">is.finite</span>(bE<span class="sc">$</span>RMSE))) bE<span class="sc">$</span>RMSE <span class="cf">else</span> <span class="cn">Inf</span></span>
<span id="cb121-457"><a href="#cb121-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-458"><a href="#cb121-458" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.infinite</span>(score0) <span class="sc">&amp;&amp;</span> <span class="fu">is.infinite</span>(scoreE)) {</span>
<span id="cb121-459"><a href="#cb121-459" aria-hidden="true" tabindex="-1"></a>      src <span class="ot">&lt;-</span> <span class="cn">NA_character_</span>; bm <span class="ot">&lt;-</span> <span class="cn">NA_character_</span>; br <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb121-460"><a href="#cb121-460" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (score0 <span class="sc">&lt;=</span> scoreE) {</span>
<span id="cb121-461"><a href="#cb121-461" aria-hidden="true" tabindex="-1"></a>      src <span class="ot">&lt;-</span> <span class="st">"no_extras"</span>; bm <span class="ot">&lt;-</span> b0<span class="sc">$</span>method; br <span class="ot">&lt;-</span> score0</span>
<span id="cb121-462"><a href="#cb121-462" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb121-463"><a href="#cb121-463" aria-hidden="true" tabindex="-1"></a>      src <span class="ot">&lt;-</span> <span class="st">"with_extras"</span>; bm <span class="ot">&lt;-</span> bE<span class="sc">$</span>method; br <span class="ot">&lt;-</span> scoreE</span>
<span id="cb121-464"><a href="#cb121-464" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-465"><a href="#cb121-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-466"><a href="#cb121-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb121-467"><a href="#cb121-467" aria-hidden="true" tabindex="-1"></a>      <span class="at">ts_key      =</span> k,</span>
<span id="cb121-468"><a href="#cb121-468" aria-hidden="true" tabindex="-1"></a>      <span class="at">stamp       =</span> <span class="fu">pretty_time</span>(k),</span>
<span id="cb121-469"><a href="#cb121-469" aria-hidden="true" tabindex="-1"></a>      <span class="at">R_star      =</span> rstar,</span>
<span id="cb121-470"><a href="#cb121-470" aria-hidden="true" tabindex="-1"></a>      <span class="at">best_source =</span> src,</span>
<span id="cb121-471"><a href="#cb121-471" aria-hidden="true" tabindex="-1"></a>      <span class="at">best_method =</span> bm,</span>
<span id="cb121-472"><a href="#cb121-472" aria-hidden="true" tabindex="-1"></a>      <span class="at">best_RMSE   =</span> br</span>
<span id="cb121-473"><a href="#cb121-473" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb121-474"><a href="#cb121-474" aria-hidden="true" tabindex="-1"></a>  }))</span>
<span id="cb121-475"><a href="#cb121-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-476"><a href="#cb121-476" aria-hidden="true" tabindex="-1"></a>  utils<span class="sc">::</span><span class="fu">write.csv</span>(summ, <span class="fu">file.path</span>(report_dir, <span class="st">"summary_Rstar_bestmethod.csv"</span>), <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb121-477"><a href="#cb121-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"✔ Fertig: summary_Rstar_bestmethod.csv geschrieben."</span>)</span>
<span id="cb121-478"><a href="#cb121-478" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-479"><a href="#cb121-479" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-480"><a href="#cb121-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-481"><a href="#cb121-481" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7) Save CSVs for the One Timestamp</span></span>
<span id="cb121-482"><a href="#cb121-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-485"><a href="#cb121-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-486"><a href="#cb121-486" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: save-csvs</span></span>
<span id="cb121-487"><a href="#cb121-487" aria-hidden="true" tabindex="-1"></a>ts_label <span class="ot">&lt;-</span> <span class="fu">pretty_time</span>(pick_ts)</span>
<span id="cb121-488"><a href="#cb121-488" aria-hidden="true" tabindex="-1"></a>bench_base_csv <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"benchmark_%s.csv"</span>,        <span class="fu">slug</span>(ts_label)))</span>
<span id="cb121-489"><a href="#cb121-489" aria-hidden="true" tabindex="-1"></a>bench_ex_csv   <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"benchmark_extras_%s.csv"</span>, <span class="fu">slug</span>(ts_label)))</span>
<span id="cb121-490"><a href="#cb121-490" aria-hidden="true" tabindex="-1"></a>eb_base_csv    <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"error_budget_%s.csv"</span>,     <span class="fu">slug</span>(ts_label)))</span>
<span id="cb121-491"><a href="#cb121-491" aria-hidden="true" tabindex="-1"></a>eb_ex_csv      <span class="ot">&lt;-</span> <span class="fu">file.path</span>(report_dir, <span class="fu">sprintf</span>(<span class="st">"error_budget_extras_%s.csv"</span>, <span class="fu">slug</span>(ts_label)))</span>
<span id="cb121-492"><a href="#cb121-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-493"><a href="#cb121-493" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.list</span>(res_one<span class="sc">$</span>bench)    <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>bench<span class="sc">$</span>table))    <span class="fu">write.csv</span>(res_one<span class="sc">$</span>bench<span class="sc">$</span>table,    bench_base_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb121-494"><a href="#cb121-494" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.list</span>(res_one<span class="sc">$</span>bench_ex) <span class="sc">&amp;&amp;</span> <span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>bench_ex<span class="sc">$</span>table)) <span class="fu">write.csv</span>(res_one<span class="sc">$</span>bench_ex<span class="sc">$</span>table, bench_ex_csv,   <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb121-495"><a href="#cb121-495" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>errtab))    <span class="fu">write.csv</span>(res_one<span class="sc">$</span>errtab,    eb_base_csv, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb121-496"><a href="#cb121-496" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.data.frame</span>(res_one<span class="sc">$</span>errtab_ex)) <span class="fu">write.csv</span>(res_one<span class="sc">$</span>errtab_ex, eb_ex_csv,   <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb121-497"><a href="#cb121-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-498"><a href="#cb121-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-499"><a href="#cb121-499" aria-hidden="true" tabindex="-1"></a><span class="fu">## 8) Console Summary</span></span>
<span id="cb121-500"><a href="#cb121-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-503"><a href="#cb121-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-504"><a href="#cb121-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: console-summary</span></span>
<span id="cb121-505"><a href="#cb121-505" aria-hidden="true" tabindex="-1"></a>n_stations <span class="ot">&lt;-</span> <span class="fu">nrow</span>(stations_pos)</span>
<span id="cb121-506"><a href="#cb121-506" aria-hidden="true" tabindex="-1"></a>n_pts_ts   <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.finite</span>(m[[pick_ts]]))</span>
<span id="cb121-507"><a href="#cb121-507" aria-hidden="true" tabindex="-1"></a>Ls         <span class="ot">&lt;-</span> <span class="fu">get_Ls</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>L)</span>
<span id="cb121-508"><a href="#cb121-508" aria-hidden="true" tabindex="-1"></a>Ls_e       <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(res_one<span class="sc">$</span>wf_ex)) <span class="fu">get_Ls</span>(res_one<span class="sc">$</span>wf_ex<span class="sc">$</span>L) <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb121-509"><a href="#cb121-509" aria-hidden="true" tabindex="-1"></a>Rstar_base <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(res_one<span class="sc">$</span>tune<span class="sc">$</span>R_star))</span>
<span id="cb121-510"><a href="#cb121-510" aria-hidden="true" tabindex="-1"></a>Rstar_ex   <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(res_one<span class="sc">$</span>tune_ex<span class="sc">$</span>R_star))</span>
<span id="cb121-511"><a href="#cb121-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-512"><a href="#cb121-512" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Chosen R (micro/local): %s / %s m</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb121-513"><a href="#cb121-513" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(<span class="fu">is.finite</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'micro'</span>]), <span class="fu">round</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'micro'</span>]), <span class="st">"NA"</span>),</span>
<span id="cb121-514"><a href="#cb121-514" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ifelse</span>(<span class="fu">is.finite</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'local'</span>]), <span class="fu">round</span>(res_one<span class="sc">$</span>wf<span class="sc">$</span>R[<span class="st">'local'</span>]), <span class="st">"NA"</span>)</span>
<span id="cb121-515"><a href="#cb121-515" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb121-516"><a href="#cb121-516" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-517"><a href="#cb121-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-518"><a href="#cb121-518" aria-hidden="true" tabindex="-1"></a><span class="fu">## 9) Shiny Viewer (Optional, uses existing files)</span></span>
<span id="cb121-519"><a href="#cb121-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-520"><a href="#cb121-520" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The viewer launches a Shiny app; to not block Quarto rendering, the launch is wrapped in </span><span class="in">`if (interactive())`</span><span class="at">.</span></span>
<span id="cb121-521"><a href="#cb121-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-524"><a href="#cb121-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-525"><a href="#cb121-525" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: viewer-funcs</span></span>
<span id="cb121-526"><a href="#cb121-526" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal viewer injection: use your working run_mc_viewer() with robust file matching</span></span>
<span id="cb121-527"><a href="#cb121-527" aria-hidden="true" tabindex="-1"></a>raster_path <span class="ot">&lt;-</span> <span class="cf">function</span>(method, ts) {</span>
<span id="cb121-528"><a href="#cb121-528" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(method) <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">length</span>(ts) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb121-529"><a href="#cb121-529" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">tolower</span>(method)</span>
<span id="cb121-530"><a href="#cb121-530" aria-hidden="true" tabindex="-1"></a>  .ts_tokens <span class="ot">&lt;-</span> <span class="cf">function</span>(ts_key) {</span>
<span id="cb121-531"><a href="#cb121-531" aria-hidden="true" tabindex="-1"></a>    raw <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">as.character</span>(ts_key))</span>
<span id="cb121-532"><a href="#cb121-532" aria-hidden="true" tabindex="-1"></a>    pty <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">pretty_time</span>(ts_key))</span>
<span id="cb121-533"><a href="#cb121-533" aria-hidden="true" tabindex="-1"></a>    slug_pt <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^0-9A-Za-z_-]+"</span>,<span class="st">"-"</span>, pty)</span>
<span id="cb121-534"><a href="#cb121-534" aria-hidden="true" tabindex="-1"></a>    d14 <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"^a"</span>, <span class="st">""</span>, raw)</span>
<span id="cb121-535"><a href="#cb121-535" aria-hidden="true" tabindex="-1"></a>    ymd  <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">nchar</span>(d14) <span class="sc">&gt;=</span> <span class="dv">8</span>) <span class="fu">substr</span>(d14,<span class="dv">1</span>,<span class="dv">8</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb121-536"><a href="#cb121-536" aria-hidden="true" tabindex="-1"></a>    hhmm <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">nchar</span>(d14) <span class="sc">&gt;=</span> <span class="dv">12</span>) <span class="fu">substr</span>(d14,<span class="dv">9</span>,<span class="dv">12</span>) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb121-537"><a href="#cb121-537" aria-hidden="true" tabindex="-1"></a>    comp1 <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ymd) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(hhmm))</span>
<span id="cb121-538"><a href="#cb121-538" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="fu">substr</span>(ymd,<span class="dv">1</span>,<span class="dv">4</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">5</span>,<span class="dv">6</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">7</span>,<span class="dv">8</span>),<span class="st">"-"</span>,</span>
<span id="cb121-539"><a href="#cb121-539" aria-hidden="true" tabindex="-1"></a>             <span class="fu">substr</span>(hhmm,<span class="dv">1</span>,<span class="dv">2</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(hhmm,<span class="dv">3</span>,<span class="dv">4</span>)) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb121-540"><a href="#cb121-540" aria-hidden="true" tabindex="-1"></a>    comp2 <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">""</span>, comp1)</span>
<span id="cb121-541"><a href="#cb121-541" aria-hidden="true" tabindex="-1"></a>    ymd_dash <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(ymd)) <span class="fu">paste0</span>(<span class="fu">substr</span>(ymd,<span class="dv">1</span>,<span class="dv">4</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">5</span>,<span class="dv">6</span>),<span class="st">"-"</span>,<span class="fu">substr</span>(ymd,<span class="dv">7</span>,<span class="dv">8</span>)) <span class="cf">else</span> <span class="cn">NA_character_</span></span>
<span id="cb121-542"><a href="#cb121-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unique</span>(<span class="fu">na.omit</span>(<span class="fu">c</span>(raw, slug_pt, comp1, comp2, ymd_dash, ymd)))</span>
<span id="cb121-543"><a href="#cb121-543" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-544"><a href="#cb121-544" aria-hidden="true" tabindex="-1"></a>  toks <span class="ot">&lt;-</span> <span class="fu">.ts_tokens</span>(ts)</span>
<span id="cb121-545"><a href="#cb121-545" aria-hidden="true" tabindex="-1"></a>  tok_rx <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[-_]"</span>, <span class="st">"[-_]"</span>, toks)</span>
<span id="cb121-546"><a href="#cb121-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-547"><a href="#cb121-547" aria-hidden="true" tabindex="-1"></a>  all_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(method_dir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.tif$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-548"><a href="#cb121-548" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(all_files)) <span class="fu">return</span>(<span class="cn">NA_character_</span>)</span>
<span id="cb121-549"><a href="#cb121-549" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">basename</span>(all_files))</span>
<span id="cb121-550"><a href="#cb121-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-551"><a href="#cb121-551" aria-hidden="true" tabindex="-1"></a>  keep_pref <span class="ot">&lt;-</span> <span class="fu">grepl</span>(<span class="fu">paste0</span>(<span class="st">"^"</span>, m, <span class="st">"_"</span>), b)</span>
<span id="cb121-552"><a href="#cb121-552" aria-hidden="true" tabindex="-1"></a>  files_m <span class="ot">&lt;-</span> all_files[keep_pref]; b_m <span class="ot">&lt;-</span> b[keep_pref]</span>
<span id="cb121-553"><a href="#cb121-553" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(files_m)) {</span>
<span id="cb121-554"><a href="#cb121-554" aria-hidden="true" tabindex="-1"></a>    score <span class="ot">&lt;-</span> <span class="fu">vapply</span>(<span class="fu">seq_along</span>(b_m), <span class="cf">function</span>(i) {</span>
<span id="cb121-555"><a href="#cb121-555" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">vapply</span>(tok_rx, <span class="cf">function</span>(rx) <span class="cf">if</span> (<span class="fu">grepl</span>(rx, b_m[i], <span class="at">perl =</span> <span class="cn">TRUE</span>)) <span class="fu">nchar</span>(rx) <span class="cf">else</span> <span class="dv">0</span>L, <span class="fu">integer</span>(<span class="dv">1</span>))))</span>
<span id="cb121-556"><a href="#cb121-556" aria-hidden="true" tabindex="-1"></a>    }, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb121-557"><a href="#cb121-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-558"><a href="#cb121-558" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(score <span class="sc">&gt;</span> <span class="dv">0</span>)) {</span>
<span id="cb121-559"><a href="#cb121-559" aria-hidden="true" tabindex="-1"></a>      best <span class="ot">&lt;-</span> files_m[score <span class="sc">==</span> <span class="fu">max</span>(score)]</span>
<span id="cb121-560"><a href="#cb121-560" aria-hidden="true" tabindex="-1"></a>      bbest <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">basename</span>(best))</span>
<span id="cb121-561"><a href="#cb121-561" aria-hidden="true" tabindex="-1"></a>      idxR <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"_rstar</span><span class="sc">\\</span><span class="st">.tif$"</span>, bbest)</span>
<span id="cb121-562"><a href="#cb121-562" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(idxR)) <span class="fu">return</span>(best[idxR[<span class="dv">1</span>]])</span>
<span id="cb121-563"><a href="#cb121-563" aria-hidden="true" tabindex="-1"></a>      idxL <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"_l95</span><span class="sc">\\</span><span class="st">.tif$"</span>, bbest)</span>
<span id="cb121-564"><a href="#cb121-564" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(idxL)) <span class="fu">return</span>(best[idxL[<span class="dv">1</span>]])</span>
<span id="cb121-565"><a href="#cb121-565" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(best[<span class="dv">1</span>])</span>
<span id="cb121-566"><a href="#cb121-566" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-567"><a href="#cb121-567" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-568"><a href="#cb121-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-569"><a href="#cb121-569" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">toupper</span>(method) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"KED"</span>,<span class="st">"PREVIEW"</span>)) {</span>
<span id="cb121-570"><a href="#cb121-570" aria-hidden="true" tabindex="-1"></a>    out_dir_local <span class="ot">&lt;-</span> <span class="fu">dirname</span>(method_dir)</span>
<span id="cb121-571"><a href="#cb121-571" aria-hidden="true" tabindex="-1"></a>    prev <span class="ot">&lt;-</span> <span class="fu">list.files</span>(out_dir_local, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.tif$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-572"><a href="#cb121-572" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(prev)) {</span>
<span id="cb121-573"><a href="#cb121-573" aria-hidden="true" tabindex="-1"></a>      bp <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">basename</span>(prev))</span>
<span id="cb121-574"><a href="#cb121-574" aria-hidden="true" tabindex="-1"></a>      rx_prev <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"^("</span>, <span class="fu">paste0</span>(tok_rx, <span class="at">collapse =</span> <span class="st">"|"</span>), <span class="st">")_interpolated(_wgs84)?</span><span class="sc">\\</span><span class="st">.tif$"</span>)</span>
<span id="cb121-575"><a href="#cb121-575" aria-hidden="true" tabindex="-1"></a>      hit <span class="ot">&lt;-</span> <span class="fu">grepl</span>(rx_prev, bp, <span class="at">perl =</span> <span class="cn">TRUE</span>)</span>
<span id="cb121-576"><a href="#cb121-576" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(hit)) <span class="fu">return</span>(prev[<span class="fu">which</span>(hit)[<span class="dv">1</span>]])</span>
<span id="cb121-577"><a href="#cb121-577" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-578"><a href="#cb121-578" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-579"><a href="#cb121-579" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NA_character_</span></span>
<span id="cb121-580"><a href="#cb121-580" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-581"><a href="#cb121-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb121-582"><a href="#cb121-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-585"><a href="#cb121-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb121-586"><a href="#cb121-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: viewer-launch</span></span>
<span id="cb121-587"><a href="#cb121-587" aria-hidden="true" tabindex="-1"></a><span class="co"># Only launch interactively</span></span>
<span id="cb121-588"><a href="#cb121-588" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">interactive</span>()) {</span>
<span id="cb121-589"><a href="#cb121-589" aria-hidden="true" tabindex="-1"></a>  explanations <span class="ot">&lt;-</span> <span class="fu">build_explanations</span>(<span class="at">fig_dir =</span> fig_dir, <span class="at">pick_ts =</span> vars[[pick_idx]])</span>
<span id="cb121-590"><a href="#cb121-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run_mc_viewer</span>(</span>
<span id="cb121-591"><a href="#cb121-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">vars         =</span> vars,</span>
<span id="cb121-592"><a href="#cb121-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">method_dir   =</span> method_dir,</span>
<span id="cb121-593"><a href="#cb121-593" aria-hidden="true" tabindex="-1"></a>    <span class="at">fig_dir      =</span> fig_dir,</span>
<span id="cb121-594"><a href="#cb121-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">stations_pos =</span> stations_pos,</span>
<span id="cb121-595"><a href="#cb121-595" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot_area    =</span> plot_area,</span>
<span id="cb121-596"><a href="#cb121-596" aria-hidden="true" tabindex="-1"></a>    <span class="at">wf           =</span> res_one<span class="sc">$</span>wf,</span>
<span id="cb121-597"><a href="#cb121-597" aria-hidden="true" tabindex="-1"></a>    <span class="at">wf_ex        =</span> res_one<span class="sc">$</span>wf_ex,</span>
<span id="cb121-598"><a href="#cb121-598" aria-hidden="true" tabindex="-1"></a>    <span class="at">tune         =</span> res_one<span class="sc">$</span>tune,</span>
<span id="cb121-599"><a href="#cb121-599" aria-hidden="true" tabindex="-1"></a>    <span class="at">tune_ex      =</span> res_one<span class="sc">$</span>tune_ex,</span>
<span id="cb121-600"><a href="#cb121-600" aria-hidden="true" tabindex="-1"></a>    <span class="at">bench        =</span> res_one<span class="sc">$</span>bench,</span>
<span id="cb121-601"><a href="#cb121-601" aria-hidden="true" tabindex="-1"></a>    <span class="at">bench_ex     =</span> res_one<span class="sc">$</span>bench_ex,</span>
<span id="cb121-602"><a href="#cb121-602" aria-hidden="true" tabindex="-1"></a>    <span class="at">tab_err      =</span> res_one<span class="sc">$</span>errtab,</span>
<span id="cb121-603"><a href="#cb121-603" aria-hidden="true" tabindex="-1"></a>    <span class="at">tab_err_ex   =</span> res_one<span class="sc">$</span>errtab_ex,</span>
<span id="cb121-604"><a href="#cb121-604" aria-hidden="true" tabindex="-1"></a>    <span class="at">explanations =</span> explanations</span>
<span id="cb121-605"><a href="#cb121-605" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb121-606"><a href="#cb121-606" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-607"><a href="#cb121-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="In die Zwischenablage kopieren" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>gisma spatial science ressources (<span class="year"></span>) — <a class="impressum-link" href="base/impressum.html">Impressum</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>