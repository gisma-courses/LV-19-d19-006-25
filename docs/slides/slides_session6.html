<!DOCTYPE html>
<html lang="de"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.32">

  <meta name="author" content="Chris Reudenbach">
  <title>Advanced GIS &amp; RS – Change detection part 1</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-83ba8bf49a63c47ab6793c327c4e96ad.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
<meta property="og:title" content="Change detection part 1 – Advanced GIS &amp; RS">
<meta property="og:description" content="gdalcubes and STAC - new dimensions in time series and change detection analysis">
<meta property="og:image" content="https://gisma-courses.github.io/LV-19-d19-006-25/slides/images/banner.png">
<meta property="og:site_name" content="Advanced GIS &amp; RS">
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" data-background-image="slide1/preview-image-mof.png" data-background-opacity="0.5" class="quarto-title-block center">
  <h1 class="title">Change detection part 1</h1>
  <p class="subtitle">gdalcubes and STAC - new dimensions in time series and change detection analysis</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Chris Reudenbach 
</div>
</div>
</div>

</section>
<section id="retrieving-sentinel-data" class="slide level2">
<h2>Retrieving Sentinel data</h2>
<div class="callout callout-important no-icon callout-style-simple">
<div class="callout-body">
<div class="callout-content">

</div>
</div>
</div>
</section>
<section>
<section id="introduction" class="title-slide slide level1 center">
<h1>Introduction</h1>
<p>Sentinel-2 is currently the most important platform for Earth observation in all areas, but especially for climate change, land use and ecological issues at all levels, from the upper micro to the global scale.</p>
<p>There are two operational Sentinel-2 satellites: Sentinel-2A and Sentinel-2B, both in sun-synchronous polar orbits and 180 degrees out of phase. This arrangement allows them to cover the mid-latitudes with an orbital period of about 5 days.</p>
<p>The Sentinel-2 data are therefore predestined to record spatial and temporal changes on the Earth’s surface (the forest was green in early summer, it has disappeared by late summer). They are ideal for timely studies before and after natural disasters, or for biomass balancing, etc.</p>
</section>
<section id="cloud-optimised-geotiffs-cogs" class="slide level2">
<h2>Cloud-Optimised GeoTIFFs (COGs)</h2>
<p>Unfortunately, the official <a href="https://scihub.copernicus.eu/dhus/#/home">Sentinel-2 archives</a> are anything but user-friendly. Even with very convenient tools such as <a href="https://sen2r.ranghetti.info/"><code>sen2r</code></a> it is sometimes tedious to process them.Technically, the processed product levels are available for download pre-processed as L1C and L2A products in JP2K format. The preferred file format is JP2K, which is storage efficient but has to be downloaded in its entirety locally by the user, resulting in high access costs and huge local storage requirements. The cloud-optimised GeoTIFFs (COGs) allow only the areas of interest to be downloaded and are also much faster to process. However, this requires optimised cloud services and a technically different access logic than in the processing chains used so far.</p>
</section>
<section id="spatiotemporal-asset-catalog-stac" class="slide level2">
<h2>SpatioTemporal Asset Catalog (STAC)</h2>
<p>The [Spatial-Temporal Asset Catalogue] (https://stacspec.org/) (STAC) provides a common language for simplified indexing and discovery of geospatial data. A “Spatio-Temporal Asset” is a file that contains information in a specific space and time.</p>
<p>This approach allows any provider of spatio-temporal data (imagery, SAR, point clouds, data cubes, full motion video, etc.) to provide Spatio-Temporal Asset Catalogues (STAC) for their data. STAC focuses on an easy-to-implement standard that organisations can use to make their data available in a durable and reliable way.</p>
<p><a href="https://www.element84.com/">Element84</a> has provided a public API called Earth-search, a central search catalogue for all public AWS datasets using STAC (including the new Sentinel-2 COGs), which contains more than 11.4 million Sentinel-2 scenes worldwide as of 1 November 2017.</p>
</section></section>
<section id="goals" class="title-slide slide level1 center">
<h1>Goals</h1>
<p>This example shows how complex times series methods from external R packages can be applied in cloud computing environments using <a href="https://cran.r-project.org/package=rstac"><code>[rstac</code></a> <span class="citation" data-cites="rstac">[@rstac]</span> and <a href="https://cran.r-project.org/package=gdalcubes"><code>gdalcubes</code></a> <span class="citation" data-cites="gdalcubes">[@gdalcubes]</span>. We will use the <a href="https://cran.r-project.org/package=bfast"><code>bfast</code> R package</a> containing unsupervised change detection methods identifying structural breakpoints in vegetation index time series. Specifically, we will use the <code>bfastmonitor()</code> function to monitor changes on a dedicated timeperiod of a time series of Sentinel-2 imagery.</p>
<p>Other packages used in this tutorial include <a href="https://cran.r-project.org/package=stars"><code>stars</code></a> <span class="citation" data-cites="stars">[@stars]</span>, <a href="https://cran.r-project.org/package=tmap"><code>tmap</code></a> <span class="citation" data-cites="tmap">[@tmap]</span> and <a href="https://cran.r-project.org/package=tmap">mapview</a> <span class="citation" data-cites="mapview">[@mapview]</span> for creating interactive maps, <a href="https://cran.r-project.org/package=sf"><code>sf</code></a> <span class="citation" data-cites="sf">[@sf]</span> for processing vector data, and <a href="https://cran.r-project.org/package=colorspace"><code>colorspace</code></a> <span class="citation" data-cites="colorspace">[@colorspace]</span> for visualizations with accessible colors.</p>
<p>Various approaches to time series and difference analyses with different indices will be applied using the example of the MOF AOI for the time period 1997 - 2021.</p>
</section>

<section>
<section id="starting-the-analysis" class="title-slide slide level1 center">
<h1>Starting the Analysis</h1>

</section>
<section id="setup-the-working-environment" class="slide level2">
<h2>Setup the working environment</h2>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a></a><span class="co"># adapt your directory this is following the concept of the envimaR structure</span></span>
<span id="cb1-2"><a></a>tutorialDir <span class="ot">=</span> <span class="fu">path.expand</span>(<span class="st">"data/"</span>)</span>
<span id="cb1-3"><a></a></span>
<span id="cb1-4"><a></a><span class="fu">library</span>(sf)</span>
<span id="cb1-5"><a></a><span class="fu">library</span>(raster)</span>
<span id="cb1-6"><a></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-7"><a></a><span class="fu">library</span>(downloader)</span>
<span id="cb1-8"><a></a><span class="fu">library</span>(tmap)</span>
<span id="cb1-9"><a></a><span class="fu">library</span>(tmaptools)</span>
<span id="cb1-10"><a></a><span class="fu">library</span>(mapview)</span>
<span id="cb1-11"><a></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb1-12"><a></a><span class="fu">library</span>(OpenStreetMap)</span>
<span id="cb1-13"><a></a><span class="fu">library</span>(stars)</span>
<span id="cb1-14"><a></a><span class="fu">library</span>(colorspace)</span>
<span id="cb1-15"><a></a><span class="fu">library</span>(rstac)</span>
<span id="cb1-16"><a></a></span>
<span id="cb1-17"><a></a></span>
<span id="cb1-18"><a></a>ndvi.col <span class="ot">=</span> <span class="cf">function</span>(n) {</span>
<span id="cb1-19"><a></a>  <span class="fu">rev</span>(<span class="fu">sequential_hcl</span>(n, <span class="st">"Green-Yellow"</span>))</span>
<span id="cb1-20"><a></a>}</span>
<span id="cb1-21"><a></a></span>
<span id="cb1-22"><a></a>ano.col <span class="ot">=</span> <span class="fu">diverging_hcl</span>(<span class="dv">7</span>, <span class="at">palette =</span> <span class="st">"Red-Green"</span>,  <span class="at">register =</span> <span class="st">"rg"</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-the-area-of-interest" class="slide level2">
<h2>Defining the Area of Interest</h2>
<p>One major challenge is the fact that most of the earth surface related remote sensing activities are heavily <em>“disturbed”</em> by the atmosphere, especially by clouds. So to find cloud free satellite imagery is a common and cumbersome task. This task is supported by the <code>rstac</code> package which provides a convenient tool to find and filter adequate Sentinel-2 images out of the COG data storage. However, to address the AOI we need to provide the extend via the <code>bbox</code> argument of the corresponding function <code>stac_search()</code>. So first we need to derive and transform the required bounding box to WGS84 geo-coordinates, easily done with the <code>sf</code> functions <code>st_bbox()</code> and <code>st_transform()</code>. In addition we adapt the projection of the referencing vector objects to all other later projection needs.</p>
<div class="boxSuccess">
<p><br></p>
<p class="textline">
</p><p>Please note to project to three different CRS is for this examples convenience and clarity and somewhat superfluous. Only the corner coordinates of the sections are required and not the complete geometries. However, it creates more clarity for the later process to already have the data needed in different projections.<br>
</p>
</div>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a></a><span class="fu">library</span>(tmap)</span>
<span id="cb2-2"><a></a><span class="fu">library</span>(tmaptools)</span>
<span id="cb2-3"><a></a>utils<span class="sc">::</span><span class="fu">download.file</span>(<span class="at">url=</span><span class="st">"https://github.com/gisma/gismaData/raw/master/MOF/MOF_CORE.gpkg"</span>,<span class="at">destfile=</span><span class="st">"../data/MOF_CORE.gpkg"</span>)</span>
<span id="cb2-4"><a></a></span>
<span id="cb2-5"><a></a>forest_mask <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"../data/MOF_CORE.gpkg"</span>)</span>
<span id="cb2-6"><a></a>sf<span class="sc">::</span><span class="fu">st_crs</span>(forest_mask) <span class="ot">&lt;-</span> <span class="dv">4326</span></span>
<span id="cb2-7"><a></a>fm<span class="ot">=</span><span class="fu">bb</span>(forest_mask,<span class="at">projection=</span><span class="dv">4326</span>)</span>
<span id="cb2-8"><a></a>forest_4326 <span class="ot">=</span><span class="fu">st_transform</span>(forest_mask,<span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb2-9"><a></a>forest_3035 <span class="ot">=</span><span class="fu">st_transform</span>(forest_mask,<span class="at">crs =</span> <span class="dv">3035</span>)</span>
<span id="cb2-10"><a></a>forest_32632 <span class="ot">=</span><span class="fu">st_transform</span>(forest_mask,<span class="at">crs =</span> <span class="dv">32632</span>)</span>
<span id="cb2-11"><a></a></span>
<span id="cb2-12"><a></a></span>
<span id="cb2-13"><a></a><span class="co"># call background map</span></span>
<span id="cb2-14"><a></a>osm_forest <span class="ot">&lt;-</span> tmaptools<span class="sc">::</span><span class="fu">read_osm</span>(fm,<span class="at">type =</span> <span class="st">"bing"</span>)</span>
<span id="cb2-15"><a></a></span>
<span id="cb2-16"><a></a><span class="co"># mapping the extents and boundaries of the choosen geometries</span></span>
<span id="cb2-17"><a></a><span class="fu">tmap_mode</span>(<span class="st">"view"</span>)</span>
<span id="cb2-18"><a></a><span class="fu">tmap_options</span>(<span class="at">check.and.fix =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb2-19"><a></a>  <span class="fu">tm_basemap</span>(<span class="at">server =</span> <span class="fu">c</span>(<span class="st">"Esri.WorldGrayCanvas"</span>, <span class="st">"OpenStreetMap"</span>, <span class="st">"Esri.WorldTopoMap"</span>,<span class="st">"Esri.WorldImagery"</span>)) <span class="sc">+</span></span>
<span id="cb2-20"><a></a>  <span class="fu">tm_shape</span>(forest_mask) <span class="sc">+</span>   </span>
<span id="cb2-21"><a></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">col=</span><span class="st">"mainTreeSp"</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our study area is pretty small, covering roughly 2.5 by 2.5 km forest area northwest of Marburg. The core part of the AOI is the Marburg Open Forest (MOF) a field research facility of the Philipps University Marburg.</p>
<h3 id="querying-images-with-rstac">Querying images with <code>rstac</code></h3>
<p>Using the <code>rstac</code> package, we first request all available images from 2017 to 2020 that intersect with our region of interest. Here, since the polygon has WGS84 as CRS, we do <strong>not</strong> need to transform the bounding box before using the <code>stac_search()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a></a><span class="co"># search the data stack for the given period and area</span></span>
<span id="cb3-2"><a></a><span class="fu">library</span>(rstac)</span>
<span id="cb3-3"><a></a></span>
<span id="cb3-4"><a></a>s <span class="ot">=</span> <span class="fu">stac</span>(<span class="st">"https://earth-search.aws.element84.com/v0"</span>)</span>
<span id="cb3-5"><a></a>items <span class="ot">&lt;-</span> s <span class="sc">|&gt;</span></span>
<span id="cb3-6"><a></a>  <span class="fu">stac_search</span>(<span class="at">collections =</span> <span class="st">"sentinel-s2-l2a-cogs"</span>,</span>
<span id="cb3-7"><a></a>              <span class="at">bbox =</span> <span class="fu">c</span>(<span class="fu">st_bbox</span>(forest_4326)[<span class="st">"xmin"</span>],</span>
<span id="cb3-8"><a></a>                       <span class="fu">st_bbox</span>(forest_4326)[<span class="st">"ymin"</span>],</span>
<span id="cb3-9"><a></a>                       <span class="fu">st_bbox</span>(forest_4326)[<span class="st">"xmax"</span>],</span>
<span id="cb3-10"><a></a>                       <span class="fu">st_bbox</span>(forest_4326)[<span class="st">"ymax"</span>]), </span>
<span id="cb3-11"><a></a>              <span class="at">datetime =</span> <span class="st">"2018-01-01/2022-12-31"</span>,</span>
<span id="cb3-12"><a></a>              <span class="at">limit =</span> <span class="dv">1000</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-13"><a></a>  <span class="fu">post_request</span>() </span>
<span id="cb3-14"><a></a>items</span>
<span id="cb3-15"><a></a></span>
<span id="cb3-16"><a></a><span class="co"># print date and time of first and last images</span></span>
<span id="cb3-17"><a></a><span class="fu">range</span>(<span class="fu">sapply</span>(items<span class="sc">$</span>features, <span class="cf">function</span>(x) {x<span class="sc">$</span>properties<span class="sc">$</span>datetime}))</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This gives us 315 matching images recorded between Januar 2019 and December 2023.</p>
<h3 id="creating-a-monthly-sentinel-2-data-cube">Creating a monthly Sentinel-2 data cube</h3>
<p>To obtain a Sentinel data cube, a gdalcube image collection must be created from the STAC query result. To do this, the asset names must be explicitly named in order to apply the SCL channel with the quality characteristics per pixel (classification as clouds, cloud shadows, etc.). In this query, a filter is set to cloud cover &lt;= 50%.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb4-2"><a></a>assets <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"B01"</span>,<span class="st">"B02"</span>,<span class="st">"B03"</span>,<span class="st">"B04"</span>,<span class="st">"B05"</span>,<span class="st">"B06"</span>, <span class="st">"B07"</span>,<span class="st">"B08"</span>,<span class="st">"B8A"</span>,<span class="st">"B09"</span>,<span class="st">"B11"</span>,<span class="st">"SCL"</span>)</span>
<span id="cb4-3"><a></a>s2_collection <span class="ot">=</span> <span class="fu">stac_image_collection</span>(items<span class="sc">$</span>features, <span class="at">asset_names =</span> assets, <span class="at">property_filter =</span> <span class="cf">function</span>(x) {x[[<span class="st">"eo:cloud_cover"</span>]] <span class="sc">&lt;</span> <span class="dv">50</span>}) </span>
<span id="cb4-4"><a></a>s2_collection</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is 107 images, i.e.&nbsp;approx. 1.8 images per month, from which we can now create a data cube. To do this, we use the UTM bounding box of our polygon as a spatial boundary, a spatial resolution of 10 metres, a bilinear spatial interpolation (useful for the spatially lower-resolution sentinel channels) and calculate monthly median values for all pixel values from the available images of a month. In addition, we add a buffer (b) on each side of the cube.</p>
<div class="boxSuccess">
<p><br></p>
<p class="textline">
</p><p>The <em>gdalcube image collection</em> can be considered as a proxy structure object which will be applied on the COGs.</p>
</div>
<p></p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a></a>b <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb5-2"><a></a>v <span class="ot">=</span> <span class="fu">cube_view</span>(<span class="at">srs =</span> <span class="st">"EPSG:32632"</span>, </span>
<span id="cb5-3"><a></a>              <span class="at">dx =</span> <span class="dv">10</span>, </span>
<span id="cb5-4"><a></a>              <span class="at">dy =</span> <span class="dv">10</span>, </span>
<span id="cb5-5"><a></a>              <span class="at">dt =</span> <span class="st">"P1M"</span>,  </span>
<span id="cb5-6"><a></a>              <span class="at">aggregation =</span> <span class="st">"median"</span>, </span>
<span id="cb5-7"><a></a>              <span class="at">extent =</span> <span class="fu">list</span>(<span class="at">t0 =</span> <span class="st">"2018-01-01"</span>,</span>
<span id="cb5-8"><a></a>                            <span class="at">t1 =</span> <span class="st">"2022-12-31"</span>, </span>
<span id="cb5-9"><a></a>                            <span class="at">left =</span> <span class="fu">st_bbox</span>(forest_32632)[<span class="st">"xmin"</span>] <span class="sc">-</span> b, </span>
<span id="cb5-10"><a></a>                            <span class="at">right =</span> <span class="fu">st_bbox</span>(forest_32632)[<span class="st">"xmax"</span>] <span class="sc">+</span> b,</span>
<span id="cb5-11"><a></a>                            <span class="at">bottom =</span> <span class="fu">st_bbox</span>(forest_32632)[<span class="st">"ymin"</span>] <span class="sc">-</span> b, </span>
<span id="cb5-12"><a></a>                            <span class="at">top =</span> <span class="fu">st_bbox</span>(forest_32632)[<span class="st">"ymax"</span>] <span class="sc">+</span> b),</span>
<span id="cb5-13"><a></a>              <span class="at">resampling =</span> <span class="st">"bilinear"</span>)</span>
<span id="cb5-14"><a></a>v</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we create a data cube, subset the red and near infrared bands and crop by our polygon, which simply sets pixel values outside the polygon to NA. We then save the data cube as a single netCDF file. Note that this is not necessary, but saving intermediate results sometimes makes debugging easier, especially if the methods applied afterwards are computationally intensive.</p>
<div class="boxSuccess">
<p><br></p>
<p class="textline">
</p><p>Only calling a final <em>action</em> will start the processing on the COG-Server. In this case ‘write_ncdf’.</p>
</div>
<p></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a><span class="co"># we "download" the data and write it t a netcdf file</span></span>
<span id="cb6-2"><a></a>  s2.mask <span class="ot">=</span> <span class="fu">image_mask</span>(<span class="st">"SCL"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">8</span>,<span class="dv">9</span>))</span>
<span id="cb6-3"><a></a>  <span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">16</span>, <span class="at">ncdf_compression_level =</span> <span class="dv">5</span>)</span>
<span id="cb6-4"><a></a>  <span class="fu">raster_cube</span>(s2_collection, v, <span class="at">mask =</span> s2.mask) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a></a>    <span class="fu">write_ncdf</span>(<span class="st">"../data/MOF_10_2.nc"</span>,<span class="at">overwrite=</span><span class="cn">TRUE</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the following examples we will show a simple plot in a generic pipe. However, a more common visualisation is quite simple. A typical pipe might be Save a resulting netCDF file <code>-&gt;</code> Convert it to a <code>stars</code> object <code>-&gt;</code> Visualise the results with <code>tmap</code>, <code>mapview</code>, <code>ggplot2</code> or whatever package you prefer to produce (interactive) map(s).</p>
<section id="reductions" class="slide level2">
<h2>Reductions</h2>
<p>Possible <em>reducers</em> include <code>min"</code>, <code>mean"</code>, <code>median"</code>, <code>max"</code>, <code>count"</code> (count non-missing values), <code>sum"</code>, <code>var"</code> (variance), and <code>sd"</code> (standard deviation). Reducer expressions are always given as a string, starting with the reducer name, followed by the band name in parentheses. Note that it is possible to mix reducers and bands.</p>
<h3 id="counting">Counting</h3>
<p>To get an idea of the data, we can compute simple summary statistics using a ‘reducer’ function over dimensions. For example, using the <code>count</code> reducer, we can learn about the temporal coverage for each aggregated pixel, giving us an initial understanding of the temporal quality of the dataset.</p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a></a><span class="fu">ncdf_cube</span>(<span class="st">"../data/MOF_10_2.nc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a></a>  <span class="fu">reduce_time</span>(<span class="st">"count(B04)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a></a>  <span class="fu">plot</span>(<span class="at">key.pos =</span> <span class="dv">1</span>,  <span class="at">col =</span> viridis<span class="sc">::</span>viridis, <span class="at">nbreaks =</span> <span class="dv">10</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that most time series contain valid observations of around 60 months, which should be sufficient for our example. Similarly, it is also possible to reduce over space, leading to summary time series.</p>
<p>Below you will find various examples dealing with the common NDVI and the <a href="https://advances.sciencemag.org/content/7/9/eabc7447">kNDVI</a> Indices.</p>
<h3 id="kndvi">kNDVI</h3>
<p>Below, we derive mean monthly kNdvi values over all pixel time series.</p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a></a><span class="fu">ncdf_cube</span>(<span class="st">"../data/MOF_10_2.nc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a></a>    <span class="fu">apply_pixel</span>(<span class="st">"tanh(((B08-B04)/(B08+B04))^2)"</span>, <span class="st">"kNDVI"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a></a>  <span class="fu">reduce_time</span>(<span class="st">"mean(kNDVI)"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a></a>  <span class="fu">plot</span>(<span class="at">key.pos =</span> <span class="dv">1</span>,  <span class="at">col =</span> ndvi.col, <span class="at">nbreaks =</span> <span class="dv">12</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ndvi" class="slide level2">
<h2>NDVI</h2>
<p>Below, we derive mean monthly Ndvi values over all pixel time series.</p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a></a><span class="fu">ncdf_cube</span>(<span class="st">"../data/MOF_10_2.nc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a></a>  <span class="fu">apply_pixel</span>(<span class="st">"(B08-B04)/(B08+B04)"</span>, <span class="st">"NDVI"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a></a>  <span class="fu">reduce_time</span>(<span class="st">"mean(NDVI)"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a></a>  <span class="fu">plot</span>(<span class="at">key.pos =</span> <span class="dv">1</span>, <span class="at">zlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.2</span>,<span class="dv">1</span>), <span class="at">col =</span> ndvi.col, <span class="at">nbreaks =</span> <span class="dv">12</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h3 id="zonal-statistics">Zonal Statistics</h3>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a></a>zstats <span class="ot">=</span> <span class="fu">ncdf_cube</span>(<span class="st">"../data/MOF_10_2.nc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a></a>  <span class="fu">apply_pixel</span>(<span class="st">"(B08-B04)/(B08+B04)"</span>, <span class="st">"NDVI"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a></a>  <span class="fu">extract_geom</span>(forest_32632,<span class="at">FUN=</span>median) </span>
<span id="cb10-4"><a></a></span>
<span id="cb10-5"><a></a>forest_32632<span class="sc">$</span>FID <span class="ot">=</span> <span class="fu">rownames</span>(forest_32632)</span>
<span id="cb10-6"><a></a>x <span class="ot">=</span> <span class="fu">merge</span>(forest_32632, zstats, <span class="at">by =</span> <span class="st">"FID"</span>)</span>
<span id="cb10-7"><a></a><span class="fu">mapview</span>(x[x<span class="sc">$</span>time <span class="sc">==</span> <span class="st">"2020-07"</span>, <span class="st">"NDVI"</span>],<span class="at">col.regions =</span> ndvi.col)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h3 id="timeseries">Timeseries</h3>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a></a><span class="fu">ncdf_cube</span>(<span class="st">"../data/MOF_10.nc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a></a>  <span class="fu">apply_pixel</span>(<span class="st">"tanh(((B08-B04)/(B08+B04))^2)"</span>, <span class="st">"kNDVI"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a></a>  <span class="fu">reduce_space</span>(<span class="st">"min(kNDVI)"</span>, <span class="st">"max(kNDVI)"</span>, <span class="st">"mean(kNDVI)"</span>) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a></a>  <span class="fu">plot</span>(<span class="at">join.timeseries =</span> <span class="cn">TRUE</span>)</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h3 id="calculate-the-annual-ndvi-difference---using-functions">Calculate the annual NDVI difference - using functions</h3>
<p>The following function will iterate through 3 years of NDVI data and calculating NDVI difference maps for each pair of years.</p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span>  <span class="dv">12</span>)</span>
<span id="cb12-2"><a></a></span>
<span id="cb12-3"><a></a><span class="co"># ndvi operand</span></span>
<span id="cb12-4"><a></a>ndvi_type <span class="ot">=</span> <span class="st">"median(kNDVI)"</span></span>
<span id="cb12-5"><a></a></span>
<span id="cb12-6"><a></a><span class="co"># time slots as tibble</span></span>
<span id="cb12-7"><a></a>ts <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">t0 =</span> <span class="fu">c</span>(<span class="st">"2018-04-01"</span>,<span class="st">"2019-04-01"</span>,<span class="st">"2020-04-01"</span>,<span class="st">"2021-04-01"</span>), </span>
<span id="cb12-8"><a></a>            <span class="at">t1=</span> <span class="fu">c</span>(<span class="st">"2018-09-01"</span>,<span class="st">"2019-09-01"</span>,<span class="st">"2020-09-01"</span>,<span class="st">"2021-09-01"</span>))</span>
<span id="cb12-9"><a></a></span>
<span id="cb12-10"><a></a><span class="co"># names of the time slots</span></span>
<span id="cb12-11"><a></a>names_ndvi <span class="ot">=</span> <span class="fu">paste</span>(ts<span class="sc">$</span>t0,ts<span class="sc">$</span>t1,<span class="at">sep =</span> <span class="st">" to "</span>)</span>
<span id="cb12-12"><a></a></span>
<span id="cb12-13"><a></a>basic_kndvi <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">fncube=</span><span class="cn">NULL</span>, <span class="at">t0=</span><span class="cn">NULL</span>, <span class="at">t1=</span><span class="cn">NULL</span>) {</span>
<span id="cb12-14"><a></a>  <span class="fu">ncdf_cube</span>(fncube) <span class="sc">|&gt;</span> </span>
<span id="cb12-15"><a></a>    <span class="fu">select_bands</span>(<span class="fu">c</span>(<span class="st">"B04"</span>, <span class="st">"B08"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb12-16"><a></a>    <span class="fu">select_time</span>(<span class="fu">c</span>(t0,t1)) <span class="sc">|&gt;</span></span>
<span id="cb12-17"><a></a>  <span class="fu">apply_pixel</span>(<span class="st">"tanh(((B08-B04)/(B08+B04))^2)"</span>, <span class="st">"kNDVI"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-18"><a></a>    <span class="fu">reduce_time</span>(ndvi_type)</span>
<span id="cb12-19"><a></a>}</span>
<span id="cb12-20"><a></a></span>
<span id="cb12-21"><a></a><span class="co"># (stac-search -&gt; stac and cloud filter image collection -&gt; create cube -&gt; call user function)</span></span>
<span id="cb12-22"><a></a>ndvi <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb12-23"><a></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ts)){</span>
<span id="cb12-24"><a></a>  <span class="co"># call user function</span></span>
<span id="cb12-25"><a></a>  <span class="fu">basic_kndvi</span>(<span class="at">fncube =</span> <span class="st">"../data/MOF_10.nc"</span>, <span class="at">t0 =</span> ts<span class="sc">$</span>t0[i], <span class="at">t1 =</span> ts<span class="sc">$</span>t1[i]) <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a></a>    <span class="fu">st_as_stars</span>() <span class="ot">-&gt;</span> ndvi[[i]]</span>
<span id="cb12-27"><a></a>  </span>
<span id="cb12-28"><a></a>}</span>
<span id="cb12-29"><a></a></span>
<span id="cb12-30"><a></a><span class="co"># now we may create a mask according to the NDVI extent and resolution</span></span>
<span id="cb12-31"><a></a>stars<span class="sc">::</span><span class="fu">write_stars</span>(ndvi[[<span class="dv">1</span>]] <span class="sc">*</span> <span class="dv">0</span>, <span class="fu">paste0</span>(tutorialDir,<span class="st">"forest/only_forestmask.tif"</span>))</span>
<span id="cb12-32"><a></a>gi<span class="ot">=</span>link2GI<span class="sc">::</span><span class="fu">linkGDAL</span>(<span class="at">searchLocation =</span> <span class="st">"/usr/bin/"</span>)</span>
<span id="cb12-33"><a></a>cmd<span class="ot">=</span>gi<span class="sc">$</span>bin[[<span class="dv">1</span>]]<span class="sc">$</span>gdal_bin[<span class="dv">14</span>]</span>
<span id="cb12-34"><a></a><span class="fu">system</span>(<span class="fu">paste</span>(cmd ,<span class="st">'-burn 1.0 -tr 10.0 10.0 -a_nodata 0.0 -te '</span>, <span class="fu">st_bbox</span>(ndvi[[<span class="dv">1</span>]])<span class="sc">$</span>xmin,<span class="st">' '</span>,<span class="fu">st_bbox</span>(ndvi[[<span class="dv">1</span>]])<span class="sc">$</span>ymin,<span class="st">' '</span>,<span class="fu">st_bbox</span>(ndvi[[<span class="dv">1</span>]])<span class="sc">$</span>xmax,<span class="st">' '</span>,<span class="fu">st_bbox</span>(ndvi[[<span class="dv">1</span>]])<span class="sc">$</span>ymax,<span class="st">' -ot Float32 -of GTiff'</span>, <span class="fu">paste0</span>(tutorialDir,<span class="st">"forest/MOF_mask_pr.shp "</span>),<span class="fu">paste0</span>(tutorialDir,<span class="st">"forest/only_forestmask.tif"</span>)))</span>
<span id="cb12-35"><a></a>mask <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="fu">paste0</span>(tutorialDir,<span class="st">"forest/only_forestmask.tif"</span>))</span>
<span id="cb12-36"><a></a><span class="fu">plot</span>(mask)                                </span>
<span id="cb12-37"><a></a></span>
<span id="cb12-38"><a></a>mask[mask <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb12-39"><a></a></span>
<span id="cb12-40"><a></a><span class="co"># mapping the results</span></span>
<span id="cb12-41"><a></a><span class="fu">tmap_mode</span>(<span class="st">"plot"</span>)</span>
<span id="cb12-42"><a></a>tm_ndvi <span class="ot">=</span> <span class="fu">lapply</span>(<span class="fu">seq</span>(<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(names_ndvi) <span class="sc">-</span><span class="dv">1</span>),<span class="cf">function</span>(i){</span>
<span id="cb12-43"><a></a>  m <span class="ot">=</span> <span class="fu">tm_shape</span>(osm_forest) <span class="sc">+</span> <span class="fu">tm_rgb</span>() <span class="sc">+</span></span>
<span id="cb12-44"><a></a>    <span class="fu">tm_shape</span>((ndvi[[i]] <span class="sc">-</span> ndvi[[i<span class="sc">+</span><span class="dv">1</span>]]) <span class="sc">*</span> <span class="fu">st_as_stars</span>(mask )) <span class="sc">+</span></span>
<span id="cb12-45"><a></a>    <span class="fu">tm_raster</span>(<span class="at">title =</span> ndvi_type,<span class="at">pal =</span><span class="fu">diverging_hcl</span>(<span class="dv">11</span>, <span class="st">"rg"</span>)) <span class="sc">+</span></span>
<span id="cb12-46"><a></a>    <span class="fu">tm_layout</span>(<span class="at">panel.labels =</span> <span class="fu">paste</span>(<span class="st">"Difference "</span>,names_ndvi[[i]],<span class="st">"/"</span>,names_ndvi[[i<span class="sc">+</span><span class="dv">1</span>]]),</span>
<span id="cb12-47"><a></a>              <span class="at">legend.show =</span> <span class="cn">TRUE</span>,</span>
<span id="cb12-48"><a></a>              <span class="at">panel.label.color =</span> <span class="st">"darkblue"</span>,</span>
<span id="cb12-49"><a></a>              <span class="at">panel.label.size =</span><span class="fl">0.5</span>,</span>
<span id="cb12-50"><a></a>              <span class="at">panel.label.height=</span><span class="fl">1.2</span>,</span>
<span id="cb12-51"><a></a>              <span class="at">legend.text.size =</span> <span class="fl">0.3</span>,</span>
<span id="cb12-52"><a></a>              <span class="at">legend.outside =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb12-53"><a></a>    <span class="fu">tm_grid</span>()</span>
<span id="cb12-54"><a></a>})</span>
<span id="cb12-55"><a></a></span>
<span id="cb12-56"><a></a></span>
<span id="cb12-57"><a></a><span class="co"># tmap_arrange(tm_ndvi,nrow = 1,asp = NA,widths = c(0.33,0.33,0.33),outer.margins = 0.001)</span></span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<h4 id="resulting-maps">Resulting maps</h4>
</section>
<section id="use-case-spatial-identification-of-magnitudes-and-time-periods-of-kndvi-changes" class="slide level2">
<h2>Use case: Spatial identification of magnitudes and time periods of kNDVI changes</h2>
<p>To apply a more complex time series method such as <code>bfastmonitor()</code>, the data cube operations below allow to provide custom user-defined R functions instead of string expressions, which translate to built-in reducers. It is very important that these functions receive arrays as input and must return arrays as output, too. Depending on the operation, the dimensionality of the arrays is different:</p>
<table class="caption-top">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Operator</th>
<th style="text-align: left;">Input</th>
<th style="text-align: left;">Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>apply_pixel</code></td>
<td style="text-align: left;">Vector of band values for one pixel</td>
<td style="text-align: left;">Vector of band values of one pixel</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>reduce_time</code></td>
<td style="text-align: left;">Multi-band time series as a matrix</td>
<td style="text-align: left;">Vector of band values</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>reduce_space</code></td>
<td style="text-align: left;">Three-dimensional array with dimensions bands, x, and y</td>
<td style="text-align: left;">Vector of band values</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>apply_time</code></td>
<td style="text-align: left;">Multi-band time series as a matrix</td>
<td style="text-align: left;">Multi-band time series as a matrix</td>
</tr>
</tbody>
</table>
<p>There is almost no limit of what R function we use, but we must take care of a few things: 1. The reducer function is executed in a new R process without access to the current workspace. It is not possible to access variables defined outside of the function and packages must be loaded <strong>within</strong> the function. 2. The reducer function <strong>must</strong> always return a vector with the same length (for all time series). 3. It is a good idea to think about <code>NA</code> values, i.e.&nbsp;you should check whether the complete time series is <code>NA</code>, and that missing values do not produce errors.</p>
<p>Another possibility to apply R functions to data cubes is of course to convert data cubes to <code>stars</code> objects and use the <code>stars</code> package for further analysis.</p>
<h3 id="applying-bfastmonitor-as-a-user-defined-reducer-function">Applying <code>bfastmonitor</code> as a user-defined reducer function</h3>
<p>In our example, <code>bfastmonitor</code> returns change date and change magnitude values per time series so we can use <code>reduce_time()</code>. The script below (1) calculates the <a href="https://advances.sciencemag.org/content/7/9/eabc7447">kNDVI</a>, (2) applies <code>bfastmonitor()</code>, and properly handles errors e.g.&nbsp;due to missing data with <code>tryCatch()</code>, and (3) finally writes out the resulting change dates and magnitudes of change for all pixels of the time series as a netCDF file. The results shows the changes starting at 1/2019 until 12/2021 and identify pretty well the dynamical impacts of drought and bark beetle in the Marburg University Forest (MOF).</p>
<div class="cell" data-messages="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a><span class="fu">library</span>(sf)</span>
<span id="cb13-2"><a></a><span class="fu">library</span>(tmap)</span>
<span id="cb13-3"><a></a><span class="fu">library</span>(tmaptools)</span>
<span id="cb13-4"><a></a><span class="fu">library</span>(gdalcubes)</span>
<span id="cb13-5"><a></a><span class="fu">library</span>(stars)</span>
<span id="cb13-6"><a></a><span class="fu">library</span>(colorspace)</span>
<span id="cb13-7"><a></a>ndvi.col <span class="ot">=</span> <span class="cf">function</span>(n) {</span>
<span id="cb13-8"><a></a>  <span class="fu">rev</span>(<span class="fu">sequential_hcl</span>(n, <span class="st">"Green-Yellow"</span>))</span>
<span id="cb13-9"><a></a>}</span>
<span id="cb13-10"><a></a>tutorialDir <span class="ot">=</span> <span class="fu">path.expand</span>(<span class="st">"~/edu/agis/doc/data/tutorial/"</span>)</span>
<span id="cb13-11"><a></a></span>
<span id="cb13-12"><a></a>figtrim <span class="ot">&lt;-</span> <span class="cf">function</span>(path) {</span>
<span id="cb13-13"><a></a>  img <span class="ot">&lt;-</span> magick<span class="sc">::</span><span class="fu">image_trim</span>(magick<span class="sc">::</span><span class="fu">image_read</span>(path))</span>
<span id="cb13-14"><a></a>  magick<span class="sc">::</span><span class="fu">image_write</span>(img, path)</span>
<span id="cb13-15"><a></a>  path</span>
<span id="cb13-16"><a></a>}</span>
<span id="cb13-17"><a></a><span class="fu">gdalcubes_options</span>(<span class="at">parallel =</span> <span class="dv">12</span>)</span>
<span id="cb13-18"><a></a><span class="do">## start analysis</span></span>
<span id="cb13-19"><a></a><span class="fu">system.time</span>(</span>
<span id="cb13-20"><a></a>  <span class="fu">ncdf_cube</span>(<span class="st">"../data/MOF_10.nc"</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-21"><a></a>    <span class="fu">reduce_time</span>(<span class="at">names =</span> <span class="fu">c</span>(<span class="st">"change_date"</span>, <span class="st">"change_magnitude"</span>,<span class="st">"kndvi"</span>), <span class="at">FUN =</span> <span class="cf">function</span>(x) {</span>
<span id="cb13-22"><a></a>      kndvi <span class="ot">=</span> <span class="fu">tanh</span>(((x[<span class="st">'B08'</span>,]<span class="sc">-</span>x[<span class="st">'B04'</span>,])<span class="sc">/</span>(x[<span class="st">'B08'</span>,]<span class="sc">+</span>x[<span class="st">'B04'</span>,]))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb13-23"><a></a>      <span class="cf">if</span> (<span class="fu">all</span>(<span class="fu">is.na</span>(kndvi))) {</span>
<span id="cb13-24"><a></a>        <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>))</span>
<span id="cb13-25"><a></a>      }</span>
<span id="cb13-26"><a></a>      kndvi_ts <span class="ot">=</span> <span class="fu">ts</span>(kndvi, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2017</span>, <span class="dv">1</span>), <span class="at">frequency =</span> <span class="dv">12</span>)</span>
<span id="cb13-27"><a></a>      <span class="fu">library</span>(bfast)</span>
<span id="cb13-28"><a></a>      <span class="fu">tryCatch</span>({</span>
<span id="cb13-29"><a></a>        result <span class="ot">=</span> <span class="fu">bfastmonitor</span>(kndvi_ts, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">2020</span>,<span class="dv">1</span>), </span>
<span id="cb13-30"><a></a>                              <span class="at">history =</span> <span class="st">"all"</span>, <span class="at">level =</span> <span class="fl">0.01</span>)</span>
<span id="cb13-31"><a></a>        <span class="fu">return</span>(<span class="fu">c</span>(result<span class="sc">$</span>breakpoint, result<span class="sc">$</span>magnitude))</span>
<span id="cb13-32"><a></a>      }, <span class="at">error =</span> <span class="cf">function</span>(x) {</span>
<span id="cb13-33"><a></a>        <span class="fu">return</span>(<span class="fu">c</span>(<span class="cn">NA</span>,<span class="cn">NA</span>))</span>
<span id="cb13-34"><a></a>      })</span>
<span id="cb13-35"><a></a>    }) <span class="sc">|&gt;</span></span>
<span id="cb13-36"><a></a>    <span class="fu">write_ncdf</span>(<span class="fu">paste0</span>(tutorialDir,<span class="st">"bf_results.nc"</span>),<span class="at">overwrite =</span> <span class="cn">TRUE</span>))</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use the netCDF file and map the results with any preferred visualisation tool. In this case <code>tmap</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a></a><span class="fu">library</span>(tmap)</span>
<span id="cb14-2"><a></a></span>
<span id="cb14-3"><a></a>mask <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="fu">paste0</span>(tutorialDir,<span class="st">"forest/only_forestmask.tif"</span>))</span>
<span id="cb14-4"><a></a><span class="co"># plotting it from the local ncdf  </span></span>
<span id="cb14-5"><a></a><span class="fu">tmap_mode</span>(<span class="st">"view"</span>)</span>
<span id="cb14-6"><a></a>gdalcubes<span class="sc">::</span><span class="fu">ncdf_cube</span>(<span class="fu">paste0</span>(tutorialDir,<span class="st">"bf_results.nc"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a></a>  stars<span class="sc">::</span><span class="fu">st_as_stars</span>() <span class="ot">-&gt;</span> x</span>
<span id="cb14-8"><a></a><span class="fu">tm_shape</span>(osm_forest) <span class="sc">+</span> <span class="fu">tm_rgb</span>() <span class="sc">+</span></span>
<span id="cb14-9"><a></a>  <span class="fu">tm_shape</span>(x[<span class="dv">1</span>] <span class="sc">*</span> <span class="fu">st_as_stars</span>(mask )) <span class="sc">+</span> </span>
<span id="cb14-10"><a></a>  <span class="fu">tm_raster</span>(<span class="at">n =</span> <span class="dv">6</span>)  <span class="sc">+</span></span>
<span id="cb14-11"><a></a>  <span class="fu">tm_layout</span>(</span>
<span id="cb14-12"><a></a>    <span class="at">legend.show =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-13"><a></a>    <span class="at">panel.label.height=</span><span class="fl">0.6</span>,</span>
<span id="cb14-14"><a></a>    <span class="at">panel.label.size=</span><span class="fl">0.6</span>,</span>
<span id="cb14-15"><a></a>    <span class="at">legend.text.size =</span> <span class="fl">0.4</span>,</span>
<span id="cb14-16"><a></a>    <span class="at">legend.outside =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb14-17"><a></a>  <span class="fu">tm_grid</span>()</span>
<span id="cb14-18"><a></a></span>
<span id="cb14-19"><a></a><span class="fu">tm_shape</span>(osm_forest) <span class="sc">+</span> <span class="fu">tm_rgb</span>() <span class="sc">+</span></span>
<span id="cb14-20"><a></a>  <span class="fu">tm_shape</span>(x[<span class="dv">2</span>]<span class="sc">*</span> <span class="fu">st_as_stars</span>(mask ))  <span class="sc">+</span> <span class="fu">tm_raster</span>() <span class="sc">+</span></span>
<span id="cb14-21"><a></a>  <span class="fu">tm_layout</span>(<span class="at">legend.title.size =</span> <span class="dv">1</span>,</span>
<span id="cb14-22"><a></a>            <span class="at">panel.label.height=</span><span class="fl">0.6</span>,</span>
<span id="cb14-23"><a></a>            <span class="at">panel.label.size=</span><span class="fl">0.6</span>,</span>
<span id="cb14-24"><a></a>            <span class="at">legend.text.size =</span> <span class="fl">0.4</span>,</span>
<span id="cb14-25"><a></a>            <span class="at">legend.outside =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb14-26"><a></a>  <span class="fu">tm_grid</span>()</span></code><button title="In die Zwischenablage kopieren" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<iframe valign="center" src="m2.html" width="1024" height="960" frameborder="0" allowfullscreen="allowfullscreen">
</iframe>
<figcaption>
<em>Magnitude Change Map</em>
</figcaption>
<p>
<iframe valign="center" src="m1.html" width="1024" height="960" frameborder="0" allowfullscreen="allowfullscreen">
</iframe>
</p><figcaption>
<em>Period of Change Map</em>
</figcaption>
<p>Running <code>bfastmonitor()</code> is computationally expensive. However, since in common (<em>not in our case</em>) the data should be located in the cloud, it would be obvious to launch one of the (payed) more powerful machine instance types with many processors. Parallelization within one instance can be controlled entirely by <code>gdalcubes</code> using <code>gdalcubes_options()</code> which is extremely simple.</p>
<p>From a scientific point of view we need to tune some aspects. The kNDVI Index together with the <code>bfastmonitor</code> approach is somewhat sophisticated and need a validation strategy. Also the correlation to the different tree species could be promising. So there is certainly a need for more analysis to understand the processes and to identify false results.</p>
</section>
<section id="summary" class="title-slide slide level1 center">
<h1>Summary</h1>
<p>This examples have shown, how simple and more more complex methods can be applied on data cubes. Especially the chosen approach to just <em>“download”</em> the data from a COG server and perform the processing on the local machine is kind of promising due to the fact that the code can be run almost identically on a cloud instance. The use of more common or well known functionalities and packages helps a lot migrating to <code>gdalcubes</code> concept.</p>
<p>It is even more powerful to use this workflow for extremely comfortable multisensor multiscale approaches.</p>
</section>

<section id="references" class="title-slide slide level1 center">
<h1>References</h1>
<p>:::</p>
<p>::::</p>
<p>:::::</p>
<hr>
</section>
<section id="minimum-temperature-c" class="slide level2">
<h2>Minimum temperature (°C)</h2>
<div class="columns">
<div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="../assets/cmip.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="CMIP6 downscaled future climate projection for 2061-2080 [model: CNRM-ESM2-1; ssp: “585”]"><img data-src="../assets/cmip.png" alt="CMIP6 downscaled future climate projection for 2061-2080 [model: CNRM-ESM2-1; ssp: “585”]"></a></p>
<figcaption>CMIP6 downscaled future climate projection for 2061-2080 [model: CNRM-ESM2-1; ssp: “585”]</figcaption>
</figure>
</div>
</div><div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><a href="../assets/wc.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="WorldClim version 2.1 climate data for 1970-2000"><img data-src="../assets/wc.png" alt="WorldClim version 2.1 climate data for 1970-2000"></a></p>
<figcaption>WorldClim version 2.1 climate data for 1970-2000</figcaption>
</figure>
</div>
</div></div>


</section>

</section></section></div>
<div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">
<p>&lt;gisma 2024&gt;</p>
</div>
</div></div>


    
  

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Kopiert");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Kopiert");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp("https:\/\/gisma-courses\.github\.io\/LV-19-d19-006-25");
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    <script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
    (function() {
      let previousOnload = window.onload;
      window.onload = () => {
        if (previousOnload) {
          previousOnload();
        }
        lightboxQuarto.on('slide_before_load', (data) => {
          const { slideIndex, slideNode, slideConfig, player, trigger } = data;
          const href = trigger.getAttribute('href');
          if (href !== null) {
            const imgEl = window.document.querySelector(`a[href="${href}"] img`);
            if (imgEl !== null) {
              const srcAttr = imgEl.getAttribute("src");
              if (srcAttr && srcAttr.startsWith("data:")) {
                slideConfig.href = srcAttr;
              }
            }
          } 
        });
      
        lightboxQuarto.on('slide_after_load', (data) => {
          const { slideIndex, slideNode, slideConfig, player, trigger } = data;
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(slideNode);
          }
        });
      
      };
      
    })();
              </script>
    

</body></html>